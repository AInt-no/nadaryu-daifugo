<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç˜æµå¤§å¯Œè±ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap');
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #1e293b;
            user-select: none;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .card {
            width: 75px;
            height: 110px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background-color: white;
            position: relative;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .card .corner-index {
            position: absolute;
            top: 2px;
            left: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 24px;
            line-height: 1;
        }
        .card .corner-index .num {
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: -1px;
        }
        .card .corner-index .suit {
            font-size: 1.1rem;
            margin-top: -2px;
        }

        .card .center-decoration {
            position: absolute;
            top: 55%;
            left: 55%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            opacity: 0.15;
            pointer-events: none;
        }

        .card .bottom-index {
            position: absolute;
            bottom: 3px;
            right: 3px;
            transform: rotate(180deg);
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.8;
            line-height: 1;
        }

        .card.red { color: #dc2626; }
        .card.black { color: #1e293b; }
        .card.joker { background-color: #fef08a; border-color: #facc15; }

        .card.selected {
            transform: translateY(-20px) scale(1.05);
            box-shadow: 0 0 0 3px #3b82f6, 0 10px 15px rgba(0,0,0,0.3);
            z-index: 100;
            background-color: #eff6ff;
        }

        /* --- æ‰‹æœ­ã‚³ãƒ³ãƒ†ãƒŠ --- */
        .player-hand {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: visible;
            padding: 30px 20px 10px 20px;
            min-height: 160px;
            width: 100%;
            -webkit-overflow-scrolling: touch;
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }
        
        .player-hand .card {
            margin-left: -48px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.15);
        }
        .player-hand .card:first-child { margin-left: 5px; }
        .player-hand .card:last-child { margin-right: 20px; }

        /* --- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ --- */
        .field-cards {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 120px;
            gap: 6px;
        }
        .field-cards .card {
            cursor: default;
            transform: none !important;
        }

        /* --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ± --- */
        .player-info {
            transition: all 0.3s ease;
            width: 5rem;
            font-size: 0.8rem;
            position: relative;
        }
        .player-info.current-turn { z-index: 10; }
        .player-info.current-turn .avatar {
            box-shadow: 0 0 0 3px #facc15, 0 0 15px rgba(250, 204, 21, 0.5);
            transform: scale(1.1);
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(2px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1f2937; color: white;
            padding: 2rem; border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            text-align: center; max-width: 90%;
            border: 1px solid #374151;
        }
        
        .selection-hand {
             display: flex; justify-content: center; flex-wrap: wrap;
             gap: 8px; margin: 1rem 0; padding: 1rem;
             background-color: rgba(255,255,255,0.05);
             border-radius: 8px;
             max-height: 50vh;
             overflow-y: auto;
             align-content: flex-start;
             -webkit-overflow-scrolling: touch;
        }

        .suit-button {
            font-size: 2rem; width: 60px; height: 60px;
            border-radius: 50%; border: 2px solid #4b5563;
            background-color: white; margin: 0 5px;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .suit-button:active { transform: scale(0.9); }
        .suit-button:disabled { opacity: 0.2; cursor: not-allowed; transform: none; }

        /* --- ãƒœã‚¿ãƒ³é¡ --- */
        #reload-btn {
            position: fixed;
            top: max(15px, env(safe-area-inset-top) + 15px);
            right: 15px;
            width: 44px; height: 44px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
            z-index: 9999;
            cursor: pointer;
        }
        #leave-game-btn {
            position: fixed;
            top: max(15px, env(safe-area-inset-top) + 15px);
            left: 15px;
            background: rgba(239, 68, 68, 0.9);
            padding: 10px 16px; border-radius: 8px;
            font-size: 0.9rem; font-weight: bold;
            z-index: 9999;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="text-white h-screen overflow-hidden bg-slate-900">

    <button id="reload-btn" onclick="location.reload()" title="æ›´æ–°">ğŸ”„</button>
    <button id="leave-game-btn" class="hidden">é€€å‡º</button>

    <div id="app" class="container mx-auto p-2 h-full flex flex-col relative">

        <div id="home-screen" class="flex flex-col items-center justify-center h-full">
            <h1 class="text-5xl md:text-7xl font-black mb-10 text-yellow-400 tracking-tighter drop-shadow-lg">ç˜æµå¤§å¯Œè±ª</h1>
            <div class="w-full max-w-md bg-slate-800/50 p-6 rounded-2xl shadow-2xl border border-slate-700 backdrop-blur-md">
                <div class="mb-6">
                    <label class="block mb-2 text-sm font-bold text-gray-300">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
                    <input type="text" id="player-name" class="w-full px-4 py-3 rounded-xl bg-slate-900 border border-slate-600 text-white font-bold focus:outline-none focus:border-yellow-400 transition" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="8">
                </div>
                <button id="create-room-btn" class="w-full bg-yellow-400 hover:bg-yellow-300 text-slate-900 font-black py-4 px-4 rounded-xl text-xl shadow-lg transform transition hover:-translate-y-1 mb-4">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
                <div class="flex items-center gap-2 w-full">
                    <input type="text" id="room-id-input" class="flex-1 min-w-0 px-3 py-3 rounded-xl bg-slate-900 border border-slate-600 text-white font-bold uppercase placeholder-gray-600" placeholder="ãƒ«ãƒ¼ãƒ ID" maxlength="5">
                    <button id="join-room-btn" class="flex-shrink-0 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition whitespace-nowrap">å‚åŠ </button>
                </div>
            </div>
        </div>

        <div id="lobby-screen" class="hidden flex flex-col items-center justify-center h-full">
            <h2 class="text-2xl font-bold text-center mb-2 text-gray-300">å¾…æ©Ÿãƒ«ãƒ¼ãƒ </h2>
            <div class="text-center mb-8 bg-slate-900/50 p-6 rounded-2xl border border-slate-700">
                <p class="text-xs text-gray-400 mb-1 uppercase tracking-widest">Room ID</p>
                <p id="room-id-display" class="font-mono text-5xl font-black text-yellow-400 cursor-pointer select-all tracking-widest" onclick="copyRoomId()"></p>
                <p class="text-xs text-gray-500 mt-2">ã‚¿ãƒƒãƒ—ã—ã¦ã‚³ãƒ”ãƒ¼</p>
            </div>
            
            <div class="w-full max-w-md bg-slate-800/50 p-6 rounded-2xl shadow-lg mb-8 flex-1 overflow-y-auto max-h-[40vh] border border-slate-700">
                <h3 class="text-lg font-bold mb-4 border-b border-slate-600 pb-2 flex justify-between">
                    å‚åŠ è€… <span id="player-count" class="text-sm font-normal bg-slate-700 px-2 py-0.5 rounded">0</span>
                </h3>
                <ul id="player-list" class="space-y-2"></ul>
            </div>
            
            <div class="w-full max-w-md">
                <button id="start-game-btn" class="w-full bg-red-500 hover:bg-red-400 text-white font-black py-4 px-8 rounded-2xl text-2xl shadow-lg transform transition hover:scale-105 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed disabled:transform-none">GAME START</button>
                <p class="mt-3 text-center text-xs text-gray-500">â€»2äººä»¥ä¸Šã§é–‹å§‹å¯èƒ½ã§ã™</p>
            </div>
        </div>

        <div id="game-screen" class="hidden flex flex-col h-full justify-between pb-safe">
            <div id="other-players-container" class="flex justify-around items-start pt-4 px-2 gap-2"></div>

            <div class="flex-1 flex flex-col justify-center items-center my-2 relative">
                <div class="w-full max-w-3xl p-4 flex flex-col items-center min-h-[220px]">
                    <div id="game-info" class="flex gap-2 mb-4 min-h-[24px]"></div>
                    <div id="field" class="field-cards"></div>
                    <p class="text-xs text-slate-500 mt-2 font-bold tracking-widest uppercase">Field</p>
                </div>
            </div>

            <div id="my-hand-area" class="bg-slate-900/80 backdrop-blur-lg pb-6 pt-2 rounded-t-3xl border-t border-slate-700 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] transition-all duration-300">
                <div id="action-buttons" class="flex justify-center items-center gap-4 mb-2 min-h-[50px]">
                    <button id="play-card-btn" class="bg-blue-500 hover:bg-blue-400 text-white font-bold py-3 px-8 rounded-xl shadow-lg disabled:bg-slate-700 disabled:text-slate-500 disabled:shadow-none transition active:scale-95">å‡ºã™</button>
                    <button id="pass-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg disabled:bg-slate-800 disabled:text-slate-600 disabled:shadow-none transition active:scale-95">ãƒ‘ã‚¹</button>
                    <button id="dobon-btn" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg disabled:bg-slate-800 disabled:text-slate-600 disabled:shadow-none transition active:scale-95 border border-purple-400/30">ãƒ‰ãƒœãƒ³</button>
                </div>
                <div id="my-hand" class="player-hand"></div>
            </div>
        </div>

        <div id="game-over-modal" class="hidden modal-overlay">
            <div class="modal-content w-full max-w-md">
                <h2 id="game-over-title" class="text-4xl font-black mb-6 text-yellow-400">GAME SET</h2>
                <div id="rankings-list" class="text-left space-y-2 mb-8 bg-slate-800 p-4 rounded-xl"></div>
                <div class="flex justify-center gap-3">
                    <button id="next-game-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-xl flex-1">æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸</button>
                    <button id="leave-room-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-xl">é€€å‡º</button>
                </div>
            </div>
        </div>

        <div id="message-modal" class="hidden modal-overlay z-[2000]">
            <div id="message-content" class="bg-slate-800 text-white px-8 py-4 rounded-full shadow-2xl font-bold border border-slate-600 flex items-center gap-2"></div>
        </div>

        <div id="selection-modal" class="hidden modal-overlay">
            <div class="modal-content w-full max-w-2xl">
                <h2 id="selection-title" class="text-2xl font-bold mb-2 text-yellow-400"></h2>
                <p id="selection-description" class="mb-4 text-gray-400"></p>
                <div id="selection-hand" class="selection-hand"></div>
                <button id="confirm-selection-btn" class="bg-blue-500 hover:bg-blue-400 text-white font-bold py-3 px-10 rounded-xl disabled:bg-slate-700 mt-4">æ±ºå®š</button>
            </div>
        </div>

        <div id="dobon-check-modal" class="hidden modal-overlay z-[1200]">
            <div class="modal-content w-full max-w-md border-2 border-yellow-500">
                <h2 class="text-3xl font-black mb-2 text-yellow-400" id="dobon-check-title">ç¢ºèª</h2>
                <p class="mb-6 text-gray-300" id="dobon-check-desc">å ´ãŒæµã‚Œã¾ã™ã€‚ãƒ‰ãƒœãƒ³ã—ã¾ã™ã‹ï¼Ÿ</p>
                <div class="flex justify-center gap-4">
                    <button onclick="document.getElementById('dobon-btn').click();" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-6 rounded-xl">ãƒ‰ãƒœãƒ³ã™ã‚‹ï¼</button>
                    <button id="ack-field-clear-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-xl">æ‰¿èª (å ´ã‚’æµã™)</button>
                </div>
            </div>
        </div>
        
        <div id="waiting-ack-modal" class="hidden modal-overlay z-[1200]">
             <div class="modal-content max-w-sm">
                <p class="text-lg font-bold animate-pulse text-yellow-300">ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ‰ãƒœãƒ³ç¢ºèªå¾…ã¡...</p>
            </div>
        </div>

        <div id="agari-modal" class="hidden modal-overlay">
            <div class="modal-content max-w-sm bg-yellow-500 text-slate-900">
                <h2 class="text-5xl font-black mb-4">ã‚ãŒã‚Šï¼</h2>
                <p class="mb-6 font-bold">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
                <button id="confirm-agari-btn" class="bg-slate-900 text-white font-bold py-3 px-10 rounded-xl w-full">æ¬¡ã¸</button>
            </div>
        </div>
        <div id="received-cards-modal" class="hidden modal-overlay">
            <div class="modal-content max-w-lg">
                <h2 id="received-cards-title" class="text-xl font-bold mb-4">ã‚«ãƒ¼ãƒ‰ã‚’å—ä¿¡</h2>
                <div id="received-cards-container" class="flex justify-center flex-wrap gap-2 mb-6"></div>
                <button id="received-cards-ok-btn" class="bg-blue-500 text-white font-bold py-2 px-8 rounded-lg">ç¢ºèª</button>
            </div>
        </div>

        <div id="dobon-success-modal" class="hidden modal-overlay z-[1500]">
            <div class="modal-content bg-gradient-to-br from-yellow-300 to-yellow-500 text-slate-900 w-full max-w-xl border-4 border-purple-600 relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIiBzdHJva2U9InJnYmEoMCwwLDAsMC4wNSkiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggZD0iTTAgNDBMMDQgMEgwIDQwWiIvPjwvc3ZnPg==')] opacity-50"></div>
                <h2 class="text-6xl font-black mb-2 text-purple-900 drop-shadow-md relative z-10">ãƒ‰ãƒœãƒ³ï¼</h2>
                <div id="dobon-player-info" class="mb-4 text-xl font-bold bg-white/30 rounded-lg py-2 inline-block px-6 relative z-10"></div>
                
                <div class="bg-white/20 p-4 rounded-xl mb-4 relative z-10">
                    <p class="font-bold text-xs text-left ml-1 mb-1 opacity-70 uppercase">Hand</p>
                    <div id="dobon-hand-container" class="flex justify-center gap-1 overflow-hidden"></div>
                </div>
                
                <div class="bg-slate-900/10 p-4 rounded-xl mb-6 relative z-10">
                    <p class="font-bold text-xs text-left ml-1 mb-1 opacity-70 uppercase">Field</p>
                    <div id="dobon-field-container" class="flex justify-center gap-1 overflow-hidden"></div>
                </div>
                
                <div class="relative z-10">
                    <button id="dobon-continue-btn" class="hidden bg-purple-900 hover:bg-purple-800 text-white font-bold py-4 px-12 rounded-2xl text-xl shadow-xl transition transform hover:scale-105">ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
                    <p id="dobon-wait-message" class="hidden text-sm font-bold animate-pulse text-purple-900">ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¢ºèªå¾…ã¡...</p>
                </div>
            </div>
        </div>

        <div id="joker-suit-modal" class="hidden modal-overlay">
            <div class="modal-content max-w-md">
                <h2 class="text-2xl font-bold mb-6">ã‚¹ãƒ¼ãƒˆã‚’é¸æŠ</h2>
                <div id="joker-suit-buttons" class="flex justify-center gap-4">
                    <button class="suit-button text-slate-900" data-suit="S">â™ </button>
                    <button class="suit-button text-red-600" data-suit="H">â™¥</button>
                    <button class="suit-button text-red-600" data-suit="D">â™¦</button>
                    <button class="suit-button text-slate-900" data-suit="C">â™£</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, runTransaction, deleteField } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAduXdqwj7aeFAN9sHajCEsX0BDcUWHSv4",
            authDomain: "dai-fugo.firebaseapp.com",
            projectId: "dai-fugo",
            storageBucket: "dai-fugo.firebasestorage.app",
            messagingSenderId: "83747675254",
            appId: "1:83747675254:web:652d8bed0fe1ce045f5357"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const appId = firebaseConfig.projectId;
        let currentUser = null;
        let currentRoomId = null;
        let currentHostId = null;
        let unsubscribeRoom = null;
        let selectedCards = [];
        let cardsForSelection = [];
        let localRoomData = {};
        let localGameState = {};
        let acknowledgedEventTimestamp = null;
        let jokerAssignmentState = { jokers: [], currentIndex: 0, usedSuits: [] };

        const SUITS = ['S', 'H', 'D', 'C'];
        const NUMBERS = [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 1, 2];
        const JOKER = { suit: 'JOKER', number: 99, id: 'JOKER' };

        // Elements
        const homeScreen = document.getElementById('home-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        
        const gameOverModal = document.getElementById('game-over-modal');
        const selectionModal = document.getElementById('selection-modal');
        const receivedCardsModal = document.getElementById('received-cards-modal');
        const dobonSuccessModal = document.getElementById('dobon-success-modal');
        const jokerSuitModal = document.getElementById('joker-suit-modal');
        const agariModal = document.getElementById('agari-modal');
        
        const leaveGameBtn = document.getElementById('leave-game-btn');

        // --- Auth & Initialization ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const savedRoomId = sessionStorage.getItem('daifugoRoomId');
                if (savedRoomId && !currentRoomId) {
                    await rejoinRoom(savedRoomId);
                }
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Auth Error:", error);
                    showMessage("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
                }
            }
        });

        // --- UI Helper Functions ---
        function showScreen(screen) {
            homeScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        function showMessage(message, duration = 3000) {
            const modal = document.getElementById('message-modal');
            const content = document.getElementById('message-content');
            content.textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('hidden'), duration);
        }

        window.copyRoomId = function() {
            const roomId = document.getElementById('room-id-display').textContent;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(roomId).then(() => showMessage('ãƒ«ãƒ¼ãƒ IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))
                .catch(() => fallbackCopyTextToClipboard(roomId));
            } else {
                fallbackCopyTextToClipboard(roomId);
            }
        };

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('ãƒ«ãƒ¼ãƒ IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            } catch (err) {
                showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            document.body.removeChild(textArea);
        }

        // --- Room Management ---
        async function createRoom() {
            if (!currentUser) return showMessage("èªè¨¼æº–å‚™ä¸­...");
            const playerName = document.getElementById('player-name').value.trim() || `ã‚²ã‚¹ãƒˆ${Math.floor(Math.random()*100)}`;
            const roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
            
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, roomId);
            const newRoom = {
                roomId: roomId,
                hostId: currentUser.uid,
                players: [{ id: currentUser.uid, name: playerName, view: 'lobby' }],
                lastGameResult: null
            };

            try {
                await setDoc(roomRef, newRoom);
                currentRoomId = roomId;
                sessionStorage.setItem('daifugoRoomId', roomId);
                listenToRoomChanges(roomId);
            } catch (error) {
                console.error("Create Room Error:", error);
                showMessage("ä½œæˆå¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
        }

        async function joinRoom() {
            if (!currentUser) return showMessage("èªè¨¼æº–å‚™ä¸­...");
            const roomId = document.getElementById('room-id-input').value.trim().toUpperCase();
            if (!roomId) return showMessage("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            const playerName = document.getElementById('player-name').value.trim() || `ã‚²ã‚¹ãƒˆ${Math.floor(Math.random()*100)}`;
            
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, roomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) throw new Error("ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    const roomData = roomDoc.data();
                    if (roomData.gameState) throw new Error("ã‚²ãƒ¼ãƒ é€²è¡Œä¸­ã§ã™ã€‚");

                    if (!roomData.players.find(p => p.id === currentUser.uid)) {
                        if (roomData.players.length >= 6) throw new Error("æº€å“¡ã§ã™ã€‚");
                        const newPlayer = { id: currentUser.uid, name: playerName, view: 'lobby' };
                        transaction.update(roomRef, { players: [...roomData.players, newPlayer] });
                    }
                });
                currentRoomId = roomId;
                sessionStorage.setItem('daifugoRoomId', roomId);
                listenToRoomChanges(roomId);
            } catch (error) {
                showMessage(error.message);
            }
        }

        async function rejoinRoom(roomId) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, roomId);
            try {
                const roomDoc = await getDoc(roomRef);
                if (!roomDoc.exists() || !roomDoc.data().players.some(p => p.id === currentUser.uid)) {
                    cleanupClientState();
                    return;
                }
                currentRoomId = roomId;
                listenToRoomChanges(roomId);
            } catch (error) {
                cleanupClientState();
            }
        }

        function cleanupClientState() {
            sessionStorage.removeItem('daifugoRoomId');
            if (unsubscribeRoom) unsubscribeRoom();
            unsubscribeRoom = null;
            currentRoomId = null;
            localRoomData = {};
            localGameState = {};
            showScreen(homeScreen);
            leaveGameBtn.classList.add('hidden');
        }

        function confirmAndLeave() {
            if (confirm("æœ¬å½“ã«ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ")) {
                handleLeaveGame();
            }
        }

        async function handleLeaveGame() {
            if (!currentRoomId || !currentUser) return cleanupClientState();
            const roomId = currentRoomId;
            const userId = currentUser.uid;
            
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, roomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) return;
                    let roomData = roomDoc.data();
                    if (!roomData.players.find(p => p.id === userId)) return;

                    let remaining = roomData.players.filter(p => p.id !== userId);
                    if (remaining.length === 0) {
                        transaction.delete(roomRef);
                    } else {
                        let updates = { players: remaining };
                        if (roomData.hostId === userId) updates.hostId = remaining[0].id;
                        transaction.update(roomRef, updates);
                    }
                });
            } catch (e) { console.error(e); }
            finally { cleanupClientState(); }
        }

        // --- Game Logic Core ---
        function createDeck() {
            const deck = [];
            SUITS.forEach(suit => {
                NUMBERS.forEach(number => deck.push({ suit, number, id: `${suit}${number}` }));
            });
            deck.push({ ...JOKER, id: 'JOKER1' });
            deck.push({ ...JOKER, id: 'JOKER2' });
            return deck;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function startGame() {
            if (!currentRoomId) return;
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                 await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) return;
                    const roomData = roomDoc.data();
                    if (roomData.players.length < 2) throw new Error("2äººä»¥ä¸Šå¿…è¦ã§ã™ã€‚");
                    
                    const deck = shuffle(createDeck());
                    const hands = {};
                    roomData.players.forEach(p => hands[p.id] = []);
                    let idx = 0;
                    deck.forEach(c => {
                        hands[roomData.players[idx].id].push(c);
                        idx = (idx + 1) % roomData.players.length;
                    });
                    
                    Object.keys(hands).forEach(pid => {
                        hands[pid].sort((a, b) => getCardStrength(a) - getCardStrength(b));
                    });

                    const sortedPlayers = [...roomData.players].sort((a, b) => (a.rank || 99) - (b.rank || 99));
                    const playOrder = sortedPlayers.map(p => p.id);

                    let currentPlayerId;
                    const loser = roomData.players.find(p => p.rank === roomData.players.length);
                    if (loser) {
                        currentPlayerId = loser.id;
                    } else {
                        const d3Owner = Object.keys(hands).find(id => hands[id].some(c => c.suit === 'D' && c.number === 3));
                        currentPlayerId = d3Owner || playOrder[0];
                    }
                    
                    const playersInGame = roomData.players.map(p => ({ ...p, cardCount: hands[p.id].length, rank: null }));
                    
                    const newGameState = {
                        status: 'playing',
                        hands: hands,
                        players: playersInGame,
                        playOrder: playOrder,
                        currentPlayerId: currentPlayerId,
                        field: { cards: [], lastPlayerId: null, suitLock: null },
                        passCount: 0,
                        isRevolution: false,
                        isElevenBack: false,
                        rankings: [],
                        lastActionTimestamp: new Date().toISOString()
                    };
                    
                    transaction.update(roomRef, { 
                        gameState: newGameState, 
                        players: roomData.players.map(p => ({ ...p, view: 'game' })), 
                        lastGameResult: deleteField() 
                    });
                 });
            } catch(e) { showMessage(e.message); }
        }

        // --- Play Action ---
        async function playCards() {
            if (selectedCards.length === 0) return;
            
            const jokers = selectedCards.filter(c => c.suit === 'JOKER');
            const nonJokers = selectedCards.filter(c => c.suit !== 'JOKER');
            
            if (jokers.length > 0) {
                jokerAssignmentState = {
                    jokers: jokers,
                    currentIndex: 0,
                    usedSuits: nonJokers.map(c => c.suit)
                };
                promptNextJokerSuit();
            } else {
                executePlay(selectedCards);
            }
        }

        function promptNextJokerSuit() {
            const { jokers, currentIndex, usedSuits } = jokerAssignmentState;

            if (currentIndex >= jokers.length) {
                jokerSuitModal.classList.add('hidden');
                executePlay(selectedCards);
                return;
            }

            jokerSuitModal.classList.remove('hidden');
            const titleEl = document.querySelector('#joker-suit-modal h2');
            titleEl.textContent = jokers.length > 1 
                ? `ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼(${currentIndex + 1}/${jokers.length})ã®ã‚¹ãƒ¼ãƒˆé¸æŠ` 
                : 'ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã®ã‚¹ãƒ¼ãƒˆé¸æŠ';

            document.querySelectorAll('.suit-button').forEach(b => {
                const s = b.dataset.suit;
                b.disabled = usedSuits.includes(s);
                const newBtn = b.cloneNode(true);
                b.parentNode.replaceChild(newBtn, b);
                newBtn.addEventListener('click', () => handleJokerSuitSelection(s));
            });
        }

        function handleJokerSuitSelection(suit) {
            const { jokers, currentIndex } = jokerAssignmentState;
            const currentJoker = jokers[currentIndex];
            
            const idx = selectedCards.findIndex(c => c.id === currentJoker.id);
            if (idx !== -1) {
                selectedCards[idx] = { ...selectedCards[idx], designatedSuit: suit };
            }

            jokerAssignmentState.usedSuits.push(suit);
            jokerAssignmentState.currentIndex++;
            promptNextJokerSuit();
        }

        async function executePlay(cardsToPlay) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) throw new Error("ã‚¨ãƒ©ãƒ¼");
                    
                    let roomData = roomDoc.data();
                    let gs = roomData.gameState;
                    
                    if (currentUser.uid !== gs.currentPlayerId) throw new Error("æ‰‹ç•ªã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                    
                    const validation = isValidPlay(cardsToPlay, gs.field, gs.isRevolution, gs.isElevenBack);
                    if (!validation.valid) throw new Error(validation.message);

                    const myHand = gs.hands[currentUser.uid];
                    if (myHand.length === cardsToPlay.length) {
                        const checkCard = cardsToPlay.find(c => c.suit !== 'JOKER') || cardsToPlay[0];
                        const strNum = gs.isRevolution ? 3 : 2;
                        if (checkCard.suit === 'JOKER' || checkCard.number === strNum) {
                            throw new Error("åå‰‡ã‚ãŒã‚Šã§ã™ï¼(ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼/æœ€å¼·æ•°å­—)");
                        }
                    }

                    const newHand = myHand.filter(c => !cardsToPlay.find(sc => sc.id === c.id));
                    gs.hands[currentUser.uid] = newHand;
                    
                    const mainCard = cardsToPlay.find(c => c.suit !== 'JOKER') || cardsToPlay[0];
                    const playedNum = mainCard.number;
                    const count = cardsToPlay.length;

                    const effect = handleSpecialCards(cardsToPlay, gs);
                    gs = effect.newGameState;

                    const isSpade3 = (gs.field.cards.length === 1 && gs.field.cards[0].suit === 'JOKER' && 
                                      cardsToPlay.length === 1 && cardsToPlay[0].suit === 'S' && cardsToPlay[0].number === 3);

                    let finished = false;
                    if (newHand.length === 0) finished = true;
                    
                    if ((playedNum === 7 || playedNum === 10) && newHand.length > 0 && newHand.length <= count) {
                        finished = true;
                        gs.hands[currentUser.uid] = [];
                    }

                    if (finished) {
                        gs.status = 'awaiting_agari_acknowledgement';
                        gs.pendingAction = { type: 'agari', playerId: currentUser.uid };
                        gs.rankings.push(currentUser.uid);
                    } else {
                        if (isSpade3) {
                            gs.status = 'awaiting_spade3_confirmation';
                            gs.pendingAction = { type: 'spade3', playerId: currentUser.uid, acks: [] };
                        } else if (playedNum === 8) {
                            gs.status = 'awaiting_8giri_confirmation';
                            gs.pendingAction = { type: '8-giri', playerId: currentUser.uid, acks: [] };
                        } else if (playedNum === 5) {
                            gs.status = 'awaiting_5skip_confirmation';
                            gs.pendingAction = { type: '5-skip', playerId: currentUser.uid, count: count, acks: [] };
                        } else if (playedNum === 7 || playedNum === 10) {
                            gs.status = 'awaiting_selection';
                            gs.pendingAction = { type: playedNum === 7 ? '7-pass' : '10-discard', playerId: currentUser.uid, count: count };
                        } else {
                            if (!effect.skipTurn) {
                                gs.currentPlayerId = getNextPlayerId(gs);
                            }
                        }
                        gs.passCount = 0;
                    }

                    gs.field = { cards: cardsToPlay, lastPlayerId: currentUser.uid, suitLock: validation.newSuitLock };
                    gs.players = gs.players.map(p => ({...p, cardCount: gs.hands[p.id]?.length || 0 }));
                    gs.lastActionTimestamp = new Date().toISOString();

                    const active = gs.players.filter(p => !gs.rankings.includes(p.id));
                    if (active.length <= 1 && !finished) {
                         const last = active[0];
                         if(last) gs.rankings.push(last.id);
                         finishGame(transaction, roomRef, roomData, gs.rankings);
                    } else {
                         transaction.update(roomRef, { gameState: gs });
                    }
                });
                selectedCards = [];
            } catch (e) {
                console.error(e);
                showMessage(e.message);
            }
        }

        // --- Pass Logic ---
        async function passTurn() {
            if (currentUser.uid !== localGameState.currentPlayerId) return;
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) return;
                    let gs = roomDoc.data().gameState;
                    
                    gs.passCount += 1;
                    const activeCount = gs.players.filter(p => p.cardCount > 0 && !gs.rankings.includes(p.id)).length;

                    if (gs.passCount >= activeCount - 1 && gs.field.lastPlayerId) {
                        gs.currentPlayerId = gs.field.lastPlayerId; // è¦ªã«ãªã‚‹
                        clearFieldAndReset(gs);
                    } else {
                        gs.currentPlayerId = getNextPlayerId(gs);
                    }
                    gs.lastActionTimestamp = new Date().toISOString();
                    transaction.update(roomRef, { gameState: gs });
                });
            } catch (e) { showMessage(e.message); }
        }

        // --- Dobon Logic ---
        async function declareDobon() {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    let gs = roomDoc.data().gameState;
                    const myHand = gs.hands[currentUser.uid];
                    const field = gs.field.cards;

                    if (myHand.length < 2) throw new Error("æ‰‹æœ­2æšä»¥ä¸Šå¿…è¦ã§ã™ã€‚");
                    if (!field || field.length === 0) throw new Error("å ´ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                    if (gs.field.lastPlayerId === currentUser.uid) throw new Error("è‡ªåˆ†ã«ã¯ãƒ‰ãƒœãƒ³ã§ãã¾ã›ã‚“ã€‚");

                    const handSum = myHand.reduce((s, c) => s + (c.suit==='JOKER'?0:c.number), 0);
                    const fieldSum = field.reduce((s, c) => s + (c.suit==='JOKER'?0:c.number), 0);

                    if (handSum !== fieldSum) throw new Error(`ä¸ä¸€è‡´ï¼ æ‰‹æœ­:${handSum} å ´:${fieldSum}`);

                    gs.status = 'awaiting_dobon_acknowledgement';
                    gs.rankings.push(currentUser.uid);
                    gs.hands[currentUser.uid] = [];
                    
                    gs.dobonInfo = {
                        playerName: gs.players.find(p => p.id === currentUser.uid).name,
                        playerHand: myHand,
                        fieldCards: field,
                        sum: handSum,
                        nextPlayerId: getNextPlayerId(gs)
                    };
                    transaction.update(roomRef, { gameState: gs });
                });
            } catch (e) { showMessage(e.message); }
        }

        // --- Special Card Handlers ---
        // ã€ä¿®æ­£ã€‘ å¾©æ´»ã•ã›ãŸé–¢æ•°
        function handleSpecialCards(played, gs) {
            const nonJokers = played.filter(c => c.suit !== 'JOKER');
            const nums = [...new Set(nonJokers.map(c => c.number))];
            const mainNum = nums[0] || played[0].number;
            const count = played.length;

            const isRev4 = (count === 4);
            const isRev3 = (count === 3 && mainNum === 3 && nonJokers.length > 0);
            
            if (isRev4 || isRev3) gs.isRevolution = !gs.isRevolution;
            if (mainNum === 11 && count % 2 !== 0) gs.isElevenBack = !gs.isElevenBack;

            return { newGameState: gs, skipTurn: false };
        }

        // --- Helper Logic ---
        function clearFieldAndReset(gameState) {
            gameState.field = { cards: [], lastPlayerId: null, suitLock: null };
            gameState.passCount = 0;
            if (gameState.isElevenBack) gameState.isElevenBack = false;
        }

        function getCardStrength(card, isRevolution = false, isElevenBack = false) {
            if (card.suit === 'JOKER') return 999;
            const rev = isRevolution !== isElevenBack;
            let s = card.number;
            if (s === 1) s = 14;
            if (s === 2) s = 15;
            if (rev) {
                if (s === 3) return 16;
                return 15 - (s - 3);
            }
            return s;
        }

        function isValidPlay(played, field, isRev, is11Back) {
            if (!played.length) return { valid: false, message: "é¸æŠã—ã¦ãã ã•ã„" };
            
            const playIsJoker = played.length === 1 && played[0].suit === 'JOKER';
            const playIsSpade3 = played.length === 1 && played[0].suit === 'S' && played[0].number === 3;
            const fieldIsJoker = field.cards.length === 1 && field.cards[0].suit === 'JOKER';

            const nums = played.map(c => c.suit==='JOKER' ? null : c.number).filter(n => n !== null);
            if ([...new Set(nums)].length > 1) return { valid: false, message: "åŒã˜æ•°å­—ã®ã¿å‡ºã›ã¾ã™" };

            if (fieldIsJoker && playIsSpade3) return { valid: true, newSuitLock: null };

            if (field.cards.length > 0) {
                if (played.length !== field.cards.length) return { valid: false, message: "æšæ•°ãŒé•ã„ã¾ã™" };

                const pStr = getCardStrength(played.find(c => c.suit!=='JOKER')||played[0], isRev, is11Back);
                const fStr = getCardStrength(field.cards.find(c => c.suit!=='JOKER')||field.cards[0], isRev, is11Back);

                if (pStr <= fStr) return { valid: false, message: "å¼±ã„ã‚«ãƒ¼ãƒ‰ã¯å‡ºã›ã¾ã›ã‚“" };

                if (field.suitLock) {
                    const pSuits = getCombinedSuits(played);
                    if (pSuits !== field.suitLock) return { valid: false, message: `ç¸›ã‚Šï¼[${field.suitLock}]ã®ã¿å¯` };
                }
            }

            let newLock = null;
            if (field.cards.length > 0) {
                const fSuits = getCombinedSuits(field.cards);
                const pSuits = getCombinedSuits(played);
                if (fSuits === pSuits) newLock = pSuits;
            }

            return { valid: true, newSuitLock: newLock };
        }

        function getCombinedSuits(cards) {
            const suits = cards.map(c => c.designatedSuit || c.suit).filter(s => s !== 'JOKER');
            return [...new Set(suits)].sort().join('');
        }

        function getNextPlayerId(gs) {
            let idx = gs.playOrder.indexOf(gs.currentPlayerId);
            let nextId;
            let safety = 0;
            do {
                idx = (idx + 1) % gs.playOrder.length;
                nextId = gs.playOrder[idx];
                safety++;
            } while (gs.rankings.includes(nextId) && safety < 10);
            return nextId;
        }

        function finishGame(transaction, roomRef, roomData, rankings) {
            const finishedPlayers = roomData.players.map(p => ({...p, view: 'results'}));
            transaction.update(roomRef, {
                players: finishedPlayers,
                lastGameResult: { rankings: rankings },
                gameState: deleteField()
            });
        }

        async function handleNextGameClick() {
            gameOverModal.classList.add('hidden');
            showScreen(lobbyScreen);
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (t) => {
                    const roomDoc = await t.get(roomRef);
                    if(!roomDoc.exists()) return;
                    const d = roomDoc.data();
                    
                    const pl = d.players.map(p => {
                         const r = d.lastGameResult?.rankings?.indexOf(p.id);
                         return (p.id === currentUser.uid) 
                            ? { ...p, view: 'lobby', rank: r!==-1 ? r+1 : d.players.length } 
                            : p;
                    });
                    
                    if(pl.every(p => p.view === 'lobby')) {
                        t.update(roomRef, { players: pl, gameState: deleteField(), lastGameResult: deleteField() });
                    } else {
                        t.update(roomRef, { players: pl });
                    }
                });
            } catch(e) { console.error(e); }
        }

        async function confirmAction(modalId, statusCheck) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (t) => {
                    const roomDoc = await t.get(roomRef);
                    let gs = roomDoc.data().gameState;
                    if (gs.status !== statusCheck || gs.pendingAction?.playerId !== currentUser.uid) return;

                    clearFieldAndReset(gs);
                    if (statusCheck === 'awaiting_agari_acknowledgement') {
                         gs.currentPlayerId = getNextPlayerId(gs);
                    } else {
                         gs.currentPlayerId = currentUser.uid;
                    }
                    
                    gs.status = 'playing';
                    delete gs.pendingAction;

                    const active = gs.players.filter(p => !gs.rankings.includes(p.id));
                    if (active.length <= 1) {
                        if(active[0]) gs.rankings.push(active[0].id);
                        finishGame(t, roomRef, roomDoc.data(), gs.rankings);
                    } else {
                        t.update(roomRef, { gameState: gs });
                    }
                });
                document.getElementById(modalId).classList.add('hidden');
            } catch(e){ console.error(e); }
        }
        
        async function confirmSelection() {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (t) => {
                    const roomDoc = await t.get(roomRef);
                    let gs = roomDoc.data().gameState;
                    const action = gs.pendingAction;
                    
                    if (cardsForSelection.length !== action.count) throw new Error("æšæ•°ãŒä¸æ­£ã§ã™");

                    gs.hands[currentUser.uid] = gs.hands[currentUser.uid].filter(c => !cardsForSelection.some(sc => sc.id === c.id));
                    
                    if (action.type === '7-pass') {
                        const nextId = getNextPlayerId(gs);
                        gs.hands[nextId].push(...cardsForSelection);
                        gs.hands[nextId].sort((a,b) => getCardStrength(a) - getCardStrength(b));
                        gs.lastEvent = { type: '7-pass', recipientId: nextId, senderName: gs.players.find(p=>p.id===currentUser.uid).name, cards: cardsForSelection, timestamp: Date.now() };
                    }

                    gs.status = 'playing';
                    gs.currentPlayerId = getNextPlayerId(gs);
                    delete gs.pendingAction;
                    
                    if (gs.hands[currentUser.uid].length === 0 && !gs.rankings.includes(currentUser.uid)) {
                        gs.rankings.push(currentUser.uid);
                        const active = gs.players.filter(p => !gs.rankings.includes(p.id));
                        if (active.length <= 1) {
                            if(active[0]) gs.rankings.push(active[0].id);
                            finishGame(t, roomRef, roomDoc.data(), gs.rankings);
                            return;
                        }
                    }
                    
                    t.update(roomRef, { gameState: gs });
                });
                selectionModal.classList.add('hidden');
                cardsForSelection = [];
            } catch(e) { showMessage(e.message); }
        }
        
        async function resumeAfterDobon() {
             const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
             await runTransaction(db, async (t) => {
                 const d = (await t.get(roomRef)).data();
                 let gs = d.gameState;
                 if (gs.status !== 'awaiting_dobon_acknowledgement') return;
                 
                 gs.currentPlayerId = gs.dobonInfo.nextPlayerId;
                 clearFieldAndReset(gs);
                 delete gs.dobonInfo;
                 gs.status = 'playing';
                 
                 const active = gs.players.filter(p => !gs.rankings.includes(p.id));
                 if (active.length <= 1) {
                     if(active[0]) gs.rankings.push(active[0].id);
                     finishGame(t, roomRef, d, gs.rankings);
                 } else {
                     t.update(roomRef, { gameState: gs });
                 }
             });
             dobonSuccessModal.classList.add('hidden');
        }

        async function acknowledgeFieldClear() {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (t) => {
                    const doc = await t.get(roomRef);
                    if (!doc.exists()) return;
                    let gs = doc.data().gameState;
                    
                    if (!['awaiting_8giri_confirmation', 'awaiting_5skip_confirmation', 'awaiting_spade3_confirmation'].includes(gs.status)) return;

                    if (!gs.pendingAction.acks) gs.pendingAction.acks = [];
                    if (!gs.pendingAction.acks.includes(currentUser.uid)) {
                        gs.pendingAction.acks.push(currentUser.uid);
                    }

                    const activePlayers = gs.players.filter(p => !gs.rankings.includes(p.id));
                    
                    if (gs.pendingAction.acks.length >= activePlayers.length - 1) {
                        
                        if (gs.status === 'awaiting_5skip_confirmation') {
                             const skips = (2 * gs.pendingAction.count) - 1;
                             if (skips >= activePlayers.length - 1) {
                                 clearFieldAndReset(gs);
                                 gs.currentPlayerId = gs.pendingAction.playerId;
                             } else {
                                 let target = gs.pendingAction.playerId;
                                 for(let i=0; i<=skips; i++) target = getNextPlayerId({...gs, currentPlayerId: target});
                                 gs.currentPlayerId = target;
                             }
                        } else {
                             clearFieldAndReset(gs);
                             gs.currentPlayerId = gs.pendingAction.playerId;
                        }
                        
                        gs.status = 'playing';
                        delete gs.pendingAction;
                    }

                    t.update(roomRef, { gameState: gs });
                });
                document.getElementById('dobon-check-modal').classList.add('hidden');
            } catch(e) { console.error(e); }
        }

        // --- UI Updates ---
        function listenToRoomChanges(roomId) {
            if (unsubscribeRoom) unsubscribeRoom();
            unsubscribeRoom = onSnapshot(doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, roomId), (snapshot) => {
                if (!snapshot.exists()) { cleanupClientState(); return; }
                
                localRoomData = snapshot.data();
                localGameState = localRoomData.gameState || {};
                currentHostId = localRoomData.hostId;
                leaveGameBtn.classList.remove('hidden');

                const me = localRoomData.players.find(p => p.id === currentUser.uid);
                if (!me) { cleanupClientState(); return; }
                
                document.getElementById('player-count').textContent = `${localRoomData.players.length}äºº`;

                if (me.view === 'game' && localGameState.status) {
                    updateGameUI(localGameState, localRoomData.players);
                } else if (me.view === 'results') {
                    showGameOverUI(localRoomData);
                } else {
                    showScreen(lobbyScreen);
                    updateLobbyUI(localRoomData);
                }
                
                if (localGameState.lastEvent && localGameState.lastEvent.recipientId === currentUser.uid && 
                    localGameState.lastEvent.timestamp !== acknowledgedEventTimestamp) {
                    acknowledgedEventTimestamp = localGameState.lastEvent.timestamp;
                    showReceivedCards(localGameState.lastEvent);
                }
            });
        }

        function updateLobbyUI(data) {
            document.getElementById('room-id-display').textContent = data.roomId;
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            data.players.forEach(p => {
                const li = document.createElement('li');
                li.className = 'bg-slate-700/50 p-3 rounded-lg flex justify-between items-center border border-slate-600';
                li.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center font-bold text-sm">${p.name.substring(0,1)}</div>
                        <span>${p.name}</span>
                    </div>
                    ${p.id === data.hostId ? '<span class="text-xs bg-yellow-500 text-slate-900 px-2 py-1 rounded font-bold">HOST</span>' : ''}
                `;
                list.appendChild(li);
            });
            const btn = document.getElementById('start-game-btn');
            if (currentUser.uid === data.hostId) {
                btn.classList.remove('hidden');
                btn.disabled = data.players.length < 2;
            } else {
                btn.classList.add('hidden');
            }
        }

        function updateGameUI(gs, players) {
            showScreen(gameScreen);
            
            const handDiv = document.getElementById('my-hand');
            handDiv.innerHTML = '';
            const myHand = gs.hands[currentUser.uid] || [];
            const finished = gs.rankings.includes(currentUser.uid);
            
            if (finished) {
                const rank = gs.rankings.indexOf(currentUser.uid) + 1;
                handDiv.innerHTML = `<div class="w-full text-center"><div class="text-5xl font-black text-yellow-400 animate-bounce py-8 drop-shadow-lg">${rank}ä½</div><div class="text-slate-400 font-bold">WAITING...</div></div>`;
                handDiv.classList.remove('justify-start');
                handDiv.classList.add('justify-center');
            } else {
                handDiv.classList.add('justify-start');
                handDiv.classList.remove('justify-center');
                myHand.forEach(c => {
                    const el = createCardEl(c);
                    if (selectedCards.some(s => s.id === c.id)) el.classList.add('selected');
                    el.onclick = () => toggleSelect(c, el);
                    handDiv.appendChild(el);
                });
            }

            const fieldDiv = document.getElementById('field');
            fieldDiv.innerHTML = '';
            (gs.field.cards||[]).forEach(c => fieldDiv.appendChild(createCardEl(c)));
            if(gs.field.cards.length === 0) fieldDiv.innerHTML = '<div class="w-20 h-28 border-2 border-dashed border-slate-600 rounded-lg flex items-center justify-center opacity-50"><span class="text-2xl">âˆ…</span></div>';
            
            const infoDiv = document.getElementById('game-info');
            infoDiv.innerHTML = '';
            if (gs.isRevolution) infoDiv.innerHTML += '<span class="text-xs font-bold text-white bg-red-600 px-2 py-1 rounded shadow-lg animate-pulse">é©å‘½</span>';
            if (gs.isElevenBack) infoDiv.innerHTML += '<span class="text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded shadow-lg">11Back</span>';
            if (gs.field.suitLock) {
                const suitMap = { S: 'â™ ', H: 'â™¥', D: 'â™¦', C: 'â™£' };
                const lockStr = gs.field.suitLock.split('').map(s => suitMap[s]).join('');
                infoDiv.innerHTML += `<span class="text-xs font-bold text-slate-900 bg-green-400 px-2 py-1 rounded shadow-lg">ç¸›:${lockStr}</span>`;
            }

            const otherDiv = document.getElementById('other-players-container');
            otherDiv.innerHTML = '';
            const myIdx = players.findIndex(p => p.id === currentUser.uid);
            const ordered = [...players.slice(myIdx + 1), ...players.slice(0, myIdx)];
            ordered.forEach(p => {
                const div = document.createElement('div');
                const isCurrent = p.id === gs.currentPlayerId;
                div.className = `player-info flex flex-col items-center ${isCurrent ? 'current-turn' : 'opacity-70'}`;
                const rankIdx = gs.rankings.indexOf(p.id);
                
                const gamePlayer = gs.players.find(gp => gp.id === p.id);
                const currentCardCount = gamePlayer ? gamePlayer.cardCount : 0;
                
                div.innerHTML = `
                    <div class="avatar w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold text-sm border-2 border-slate-500 mb-1 transition-transform duration-300">
                        ${p.name.substring(0,1)}
                    </div>
                    <div class="font-bold truncate w-full text-center text-xs text-slate-300 mb-0.5">${p.name}</div>
                    <div class="text-sm font-bold bg-slate-800/80 px-2 rounded-full">
                        ${rankIdx !== -1 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4th','5th','6th'][rankIdx] : 'ğŸƒ' + currentCardCount}
                    </div>
                `;
                otherDiv.appendChild(div);
            });

            const myHandArea = document.getElementById('my-hand-area');
            const isTurn = gs.currentPlayerId === currentUser.uid && !finished;
            
            if (isTurn) {
                myHandArea.classList.remove('border-slate-700');
                myHandArea.classList.add('border-yellow-400', 'border-t-4', 'shadow-[0_-5px_20px_rgba(250,204,21,0.3)]');
            } else {
                myHandArea.classList.add('border-slate-700');
                myHandArea.classList.remove('border-yellow-400', 'border-t-4', 'shadow-[0_-5px_20px_rgba(250,204,21,0.3)]');
            }

            const locked = gs.status.startsWith('awaiting');
            document.getElementById('play-card-btn').disabled = !isTurn || locked;
            document.getElementById('pass-btn').disabled = !isTurn || locked || (!gs.field.cards.length);
            
            const canDobon = !locked && !finished && myHand.length >= 2 && gs.field.cards.length > 0 && gs.field.lastPlayerId !== currentUser.uid;
            document.getElementById('dobon-btn').disabled = !canDobon;

            document.getElementById('dobon-check-modal').classList.add('hidden');
            document.getElementById('waiting-ack-modal').classList.add('hidden');
            document.getElementById('dobon-success-modal').classList.add('hidden');
            
            const waitStatuses = ['awaiting_8giri_confirmation', 'awaiting_5skip_confirmation', 'awaiting_spade3_confirmation'];
            
            if (waitStatuses.includes(gs.status)) {
                const isMyAction = gs.pendingAction?.playerId === currentUser.uid;
                
                if (isMyAction) {
                    document.getElementById('waiting-ack-modal').classList.remove('hidden');
                } else {
                    const myAck = gs.pendingAction.acks && gs.pendingAction.acks.includes(currentUser.uid);
                    if (!myAck) {
                        const titleEl = document.getElementById('dobon-check-title');
                        const descEl = document.getElementById('dobon-check-desc');
                        if(gs.status === 'awaiting_8giri_confirmation') { titleEl.textContent='8åˆ‡ã‚Šï¼'; descEl.textContent='å ´ãŒæµã‚Œã¾ã™ã€‚ãƒ‰ãƒœãƒ³ã—ã¾ã™ã‹ï¼Ÿ'; }
                        if(gs.status === 'awaiting_spade3_confirmation') { titleEl.textContent='ã‚¹ãƒš3è¿”ã—ï¼'; descEl.textContent='ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ç„¡åŠ¹åŒ–ï¼ãƒ‰ãƒœãƒ³ã—ã¾ã™ã‹ï¼Ÿ'; }
                        if(gs.status === 'awaiting_5skip_confirmation') { titleEl.textContent='5ã‚¹ã‚­ãƒƒãƒ—ï¼'; descEl.textContent='ã‚¿ãƒ¼ãƒ³ãŒé£›ã³ã¾ã™ã€‚ãƒ‰ãƒœãƒ³ã—ã¾ã™ã‹ï¼Ÿ'; }
                        
                        document.getElementById('dobon-check-modal').classList.remove('hidden');
                        document.getElementById('dobon-btn').disabled = false;
                    } else {
                        document.getElementById('waiting-ack-modal').classList.remove('hidden');
                    }
                }
            } else if (gs.pendingAction?.playerId === currentUser.uid) {
                if (gs.status === 'awaiting_selection') showSelectionModal(gs.pendingAction, myHand);
                else if (gs.status === 'awaiting_agari_acknowledgement') agariModal.classList.remove('hidden');
            }
            
            if (gs.status === 'awaiting_dobon_acknowledgement') showDobonModal(gs);
        }
        
        function createCardEl(c) {
            const div = document.createElement('div');
            div.className = 'card';
            
            const numMap = {1:'A', 11:'J', 12:'Q', 13:'K'};
            const displayNum = numMap[c.number] || c.number;

            if (c.suit === 'JOKER') {
                div.classList.add('joker');
                div.innerHTML = `
                    <div class="corner-index"><span class="text-xs font-bold pt-1">JK</span></div>
                    <div class="center-decoration">ğŸƒ</div>
                    <div class="bottom-index"><span class="text-xs font-bold">JOKER</span></div>
                `;
                if (c.designatedSuit) {
                    const s = {S:'â™ ',H:'â™¥',D:'â™¦',C:'â™£'}[c.designatedSuit];
                    const colorClass = ['H','D'].includes(c.designatedSuit) ? 'text-red-600' : 'text-slate-900';
                    div.innerHTML += `<div class="absolute top-1 right-2 ${colorClass} font-bold text-sm">${s}</div>`;
                }
            } else {
                const color = ['H','D'].includes(c.suit) ? 'red' : 'black';
                const mark = {S:'â™ ',H:'â™¥',D:'â™¦',C:'â™£'}[c.suit];
                
                div.classList.add(color);
                div.innerHTML = `
                    <div class="corner-index">
                        <span class="num">${displayNum}</span>
                        <span class="suit">${mark}</span>
                    </div>
                    <div class="center-decoration">${mark}</div>
                    <div class="bottom-index">
                        <span class="text-sm font-bold">${displayNum}</span>
                        <span class="text-xs">${mark}</span>
                    </div>
                `;
            }
            return div;
        }

        function toggleSelect(c, el) {
            const idx = selectedCards.findIndex(s => s.id === c.id);
            if (idx > -1) {
                selectedCards.splice(idx, 1);
                el.classList.remove('selected');
            } else {
                selectedCards.push(c);
                el.classList.add('selected');
            }
        }

        function promptJokerSuit() {
            jokerSuitModal.classList.remove('hidden');
            const used = selectedCards.filter(c=>c.suit!=='JOKER').map(c=>c.suit);
            document.querySelectorAll('.suit-button').forEach(b => {
                b.disabled = used.includes(b.dataset.suit);
                b.onclick = () => {
                    selectedCards = selectedCards.map(c => c.suit==='JOKER' ? {...c, designatedSuit: b.dataset.suit} : c);
                    jokerSuitModal.classList.add('hidden');
                    executePlay(selectedCards);
                };
            });
        }

        function showSelectionModal(action, hand) {
            selectionModal.classList.remove('hidden');
            document.getElementById('selection-title').textContent = action.type==='7-pass'?'7æ¸¡ã—':'10æ¨ã¦';
            document.getElementById('selection-description').textContent = `${action.count}æšé¸ã‚“ã§ãã ã•ã„`;
            const container = document.getElementById('selection-hand');
            container.innerHTML = '';
            cardsForSelection = [];
            document.getElementById('confirm-selection-btn').disabled = true;
            
            hand.forEach(c => {
                const el = createCardEl(c);
                el.onclick = () => {
                    const idx = cardsForSelection.findIndex(s => s.id === c.id);
                    if(idx > -1) { cardsForSelection.splice(idx,1); el.classList.remove('selected'); }
                    else if(cardsForSelection.length < action.count) { cardsForSelection.push(c); el.classList.add('selected'); }
                    document.getElementById('confirm-selection-btn').disabled = cardsForSelection.length !== action.count;
                };
                container.appendChild(el);
            });
        }

        function showReceivedCards(evt) {
            receivedCardsModal.classList.remove('hidden');
            const c = document.getElementById('received-cards-container');
            c.innerHTML = '';
            evt.cards.forEach(card => c.appendChild(createCardEl(card)));
            document.getElementById('received-cards-title').textContent = `${evt.senderName}ã‹ã‚‰å—ä¿¡`;
        }

        function showDobonModal(gs) {
            dobonSuccessModal.classList.remove('hidden');
            const info = gs.dobonInfo;
            document.getElementById('dobon-player-info').textContent = `${info.playerName} (åˆè¨ˆ:${info.sum})`;
            const hC = document.getElementById('dobon-hand-container'); hC.innerHTML='';
            info.playerHand.forEach(c => hC.appendChild(createCardEl(c)));
            const fC = document.getElementById('dobon-field-container'); fC.innerHTML='';
            info.fieldCards.forEach(c => fC.appendChild(createCardEl(c)));
            
            const isNext = currentUser.uid === info.nextPlayerId;
            document.getElementById('dobon-continue-btn').classList.toggle('hidden', !isNext);
            document.getElementById('dobon-wait-message').classList.toggle('hidden', isNext);
        }

        function showGameOverUI(roomData) {
            gameOverModal.classList.remove('hidden');
            const list = document.getElementById('rankings-list');
            list.innerHTML = '';
            roomData.lastGameResult.rankings.forEach((pid, i) => {
                const p = roomData.players.find(pl => pl.id === pid);
                if(p) list.innerHTML += `<div class="flex justify-between border-b border-slate-600 p-2 items-center">
                    <span class="text-yellow-400 font-black text-xl">${i+1}ä½</span>
                    <span class="font-bold text-lg">${p.name}</span>
                </div>`;
            });
        }

        // --- Event Listeners ---
        document.getElementById('create-room-btn').addEventListener('click', createRoom);
        document.getElementById('join-room-btn').addEventListener('click', joinRoom);
        document.getElementById('start-game-btn').addEventListener('click', startGame);
        document.getElementById('play-card-btn').addEventListener('click', playCards);
        document.getElementById('pass-btn').addEventListener('click', passTurn);
        document.getElementById('dobon-btn').addEventListener('click', declareDobon);
        
        document.getElementById('next-game-btn').addEventListener('click', handleNextGameClick);
        document.getElementById('leave-room-btn').addEventListener('click', confirmAndLeave);
        leaveGameBtn.addEventListener('click', confirmAndLeave);
        
        document.getElementById('confirm-selection-btn').addEventListener('click', confirmSelection);
        document.getElementById('confirm-agari-btn').addEventListener('click', () => confirmAction('agari-modal', 'awaiting_agari_acknowledgement'));
        document.getElementById('received-cards-ok-btn').addEventListener('click', () => receivedCardsModal.classList.add('hidden'));
        document.getElementById('dobon-continue-btn').addEventListener('click', resumeAfterDobon);
        
        // æ‰¿èªãƒœã‚¿ãƒ³
        document.getElementById('ack-field-clear-btn').addEventListener('click', acknowledgeFieldClear);

    </script>
</body>
</html>
