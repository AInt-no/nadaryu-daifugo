<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç˜æµå¤§å¯Œè±ª (Rev.3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #f0f2f5;
            user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠç¦æ­¢ï¼ˆã‚²ãƒ¼ãƒ æ“ä½œæ€§å‘ä¸Šï¼‰ */
        }
        .card {
            width: 80px;
            height: 120px;
            border: 1px solid #999;
            border-radius: 8px;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            flex-shrink: 0;
        }
        .card.selected {
            transform: translateY(-20px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .card.joker {
            background-color: #fde047;
        }
        .card .suit-top, .card .suit-bottom {
            font-size: 1.2rem;
            line-height: 1;
        }
        .card .suit-bottom {
            transform: rotate(180deg);
        }
        .card .number {
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
        }
        .card.red { color: #ef4444; }
        .card.black { color: #1f2937; }
        
        .player-hand {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 10px 40px 20px 40px;
            min-height: 170px;
        }
        .player-hand .card {
            margin-left: -45px; /* ã‚«ãƒ¼ãƒ‰ã‚’é‡ã­ã‚‹ */
        }
        .player-hand .card:first-child {
            margin-left: 0;
        }
        .player-hand .card:hover {
            z-index: 10; /* ãƒ›ãƒãƒ¼æ™‚ã«æ‰‹å‰ã«è¡¨ç¤º */
            transform: translateY(-10px);
        }
        .player-hand .card.selected {
            z-index: 20;
            transform: translateY(-25px);
        }

        .field-cards {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 140px;
            gap: 8px;
        }
        .player-info {
            transition: all 0.3s ease;
            transform: scale(1);
            width: 7rem;
            font-size: 0.85rem;
        }
        .player-info.current-turn {
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.8);
            transform: scale(1.1);
            border: 2px solid #fcd34d;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1f2937;
            color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 90%;
        }
        
        .selection-hand, .card-display-area {
             display: flex;
             justify-content: center;
             flex-wrap: wrap;
             gap: 8px;
             margin-top: 1rem;
             margin-bottom: 1.5rem;
             max-height: 320px;
             overflow-y: auto;
             padding: 1rem;
             background-color: rgba(255,255,255,0.1);
             border-radius: 8px;
        }
        .designated-suit {
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 1rem;
            font-weight: bold;
            opacity: 0.8;
        }
        .suit-button {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #ccc;
            background-color: #fff;
            margin: 0 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .suit-button:hover:not(:disabled) {
            transform: scale(1.1);
            border-color: #3b82f6;
        }
        .suit-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background-color: #e5e7eb;
        }

        #reload-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        #leave-game-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            background-color: rgba(239, 68, 68, 0.8);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 1100;
            padding: 8px 12px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-green-800 text-white h-screen overflow-hidden">

    <div id="app" class="container mx-auto p-2 h-full flex flex-col relative">

        <button id="reload-btn" onclick="location.reload()" title="ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°">ğŸ”„</button>
        <button id="leave-game-btn" class="hidden">é€€å‡º</button>

        <div id="home-screen" class="flex flex-col items-center justify-center h-full">
            <h1 class="text-5xl md:text-7xl font-bold mb-4 text-yellow-300 drop-shadow-lg">ç˜æµå¤§å¯Œè±ª</h1>
            <p class="mb-8 text-lg opacity-80">Rev.3 (æœ€çµ‚ç¢ºå®šç‰ˆ)</p>
            <div class="w-full max-w-md bg-white/10 p-8 rounded-xl shadow-2xl backdrop-blur-sm">
                <div class="mb-6">
                    <label for="player-name" class="block mb-2 text-sm font-bold">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
                    <input type="text" id="player-name" class="w-full px-4 py-3 rounded-lg text-gray-800 font-bold" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="8">
                </div>
                <button id="create-room-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-4 rounded-lg text-xl transition duration-300 mb-4 shadow-md">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹</button>
                <div class="flex items-center gap-2">
                    <input type="text" id="room-id-input" class="flex-1 px-4 py-3 rounded-lg text-gray-800 font-bold uppercase" placeholder="ãƒ«ãƒ¼ãƒ ID" maxlength="5">
                    <button id="join-room-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md whitespace-nowrap">å‚åŠ </button>
                </div>
            </div>
        </div>

        <div id="lobby-screen" class="hidden flex flex-col items-center justify-center h-full">
            <h2 class="text-3xl font-bold text-center mb-2">å¾…æ©Ÿãƒ«ãƒ¼ãƒ </h2>
            <div class="text-center mb-8 bg-black/30 p-4 rounded-lg">
                <p class="text-sm text-gray-300 mb-1">ãƒ«ãƒ¼ãƒ ID (ã‚¿ãƒƒãƒ—ã—ã¦ã‚³ãƒ”ãƒ¼)</p>
                <p id="room-id-display" class="font-mono text-4xl font-bold text-yellow-300 cursor-pointer select-all tracking-widest" onclick="copyRoomId()"></p>
            </div>
            
            <div class="w-full max-w-lg bg-white/10 p-6 rounded-xl shadow-lg mb-8 flex-1 overflow-y-auto max-h-[40vh]">
                <h3 class="text-xl font-bold mb-4 border-b border-white/20 pb-2">å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ <span id="player-count" class="text-sm font-normal ml-2"></span></h3>
                <ul id="player-list" class="space-y-3"></ul>
            </div>
            
            <div class="text-center w-full max-w-lg">
                <button id="start-game-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-xl text-2xl transition duration-300 shadow-lg disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                <p class="mt-2 text-sm text-gray-400">â€»2äººä»¥ä¸Šã§é–‹å§‹å¯èƒ½</p>
            </div>
        </div>

        <div id="game-screen" class="hidden flex flex-col h-full justify-between pb-safe">
            <div id="other-players-container" class="flex justify-around items-start pt-2 px-1"></div>

            <div class="flex-1 flex flex-col justify-center items-center my-2">
                <div class="bg-green-900/60 w-full max-w-3xl rounded-xl p-4 border-2 border-yellow-400/30 shadow-inner min-h-[200px] flex flex-col relative">
                    <div class="absolute top-2 left-0 right-0 text-center">
                        <div id="game-info" class="text-sm font-bold h-6 flex justify-center gap-3"></div>
                        <p class="text-xs text-gray-400 mt-1">å ´ã«å‡ºã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰</p>
                    </div>
                    
                    <div id="field" class="field-cards flex-1 mt-6"></div>
                </div>
            </div>

            <div class="bg-black/40 backdrop-blur-md pb-4 rounded-t-2xl border-t border-white/10">
                <div id="action-buttons" class="flex justify-center items-center gap-3 py-2 min-h-[60px]">
                    <button id="play-card-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg disabled:bg-gray-600 disabled:opacity-50 transition-transform active:scale-95">å‡ºã™</button>
                    <button id="pass-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg disabled:bg-gray-700 disabled:opacity-50 transition-transform active:scale-95">ãƒ‘ã‚¹</button>
                    <button id="dobon-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg disabled:bg-gray-700 disabled:opacity-30 transition-transform active:scale-95 border border-purple-400">ãƒ‰ãƒœãƒ³ï¼</button>
                </div>
                <div id="my-hand" class="player-hand"></div>
            </div>
        </div>

        <div id="game-over-modal" class="hidden modal-overlay">
            <div class="modal-content w-full max-w-md">
                <h2 id="game-over-title" class="text-3xl font-bold mb-4 text-yellow-300">ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
                <div id="rankings-list" class="text-left space-y-2 mb-6 bg-black/20 p-4 rounded"></div>
                <div class="flex justify-center gap-4">
                    <button id="next-game-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg flex-1">æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸</button>
                    <button id="leave-room-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg">é€€å‡º</button>
                </div>
            </div>
        </div>

        <div id="message-modal" class="hidden modal-overlay z-[2000]">
            <div id="message-content" class="bg-gray-900 text-white px-6 py-4 rounded-lg shadow-xl font-bold border border-gray-600"></div>
        </div>

        <div id="selection-modal" class="hidden modal-overlay">
            <div class="modal-content w-full max-w-2xl">
                <h2 id="selection-title" class="text-2xl font-bold mb-2 text-yellow-300"></h2>
                <p id="selection-description" class="mb-4 text-gray-300"></p>
                <div id="selection-hand" class="selection-hand bg-white/5"></div>
                <button id="confirm-selection-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-lg disabled:bg-gray-600 mt-2">æ±ºå®š</button>
            </div>
        </div>

        <div id="8giri-modal" class="hidden modal-overlay">
            <div class="modal-content max-w-sm">
                <h2 class="text-3xl font-bold mb-2 text-red-400">8åˆ‡ã‚Šï¼</h2>
                <p class="mb-6">å ´ã‚’æµã—ã¾ã™ã€‚</p>
                <button id="confirm-8giri-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg w-full">OK</button>
            </div>
        </div>
        <div id="5skip-modal" class="hidden modal-overlay">
            <div class="modal-content max-w-sm">
                <h2 class="text-3xl font-bold mb-2 text-blue-400">5ã‚¹ã‚­ãƒƒãƒ—</h2>
                <p class="mb-6">é †ç•ªã‚’é£›ã°ã—ã¾ã™ã€‚</p>
                <button id="confirm-5skip-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg w-full">OK</button>
            </div>
        </div>
        <div id="spade3-modal" class="hidden modal-overlay">
            <div class="modal-content max-w-sm">
                <h2 class="text-3xl font-bold mb-2 text-green-400">ã‚¹ãƒš3è¿”ã—ï¼</h2>
                <p class="mb-6">ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã€å ´ã‚’æµã—ã¾ã™ã€‚</p>
                <button id="confirm-spade3-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg w-full">OK</button>
            </div>
        </div>
        <div id="agari-modal" class="hidden modal-overlay">
            <div class="modal-content max-w-sm">
                <h2 class="text-4xl font-bold mb-4 text-yellow-300">ã‚ãŒã‚Šï¼</h2>
                <p class="mb-6">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
                <button id="confirm-agari-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg w-full">æ¬¡ã¸</button>
            </div>
        </div>
        <div id="received-cards-modal" class="hidden modal-overlay">
            <div class="modal-content max-w-lg">
                <h2 id="received-cards-title" class="text-xl font-bold mb-4">ã‚«ãƒ¼ãƒ‰ã‚’å—ã‘å–ã‚Šã¾ã—ãŸ</h2>
                <div id="received-cards-container" class="flex justify-center flex-wrap gap-2 mb-6"></div>
                <button id="received-cards-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-lg">OK</button>
            </div>
        </div>

        <div id="dobon-success-modal" class="hidden modal-overlay z-[1500]">
            <div class="modal-content bg-gradient-to-br from-yellow-200 to-yellow-500 text-black w-full max-w-2xl border-4 border-purple-600">
                <h2 class="text-6xl font-black mb-2 text-purple-800 drop-shadow-white">ãƒ‰ãƒœãƒ³ï¼</h2>
                <div id="dobon-player-info" class="mb-2 text-xl font-bold bg-white/50 rounded py-1"></div>
                
                <p class="font-bold text-sm text-left ml-4">æ‰‹æœ­</p>
                <div id="dobon-hand-container" class="flex justify-center gap-2 mb-2 overflow-x-auto p-2"></div>
                
                <div class="my-2 border-t-2 border-black/20"></div>
                
                <p class="font-bold text-sm text-left ml-4">å ´</p>
                <div id="dobon-field-container" class="flex justify-center gap-2 mb-6 overflow-x-auto p-2"></div>
                
                <div>
                    <button id="dobon-continue-btn" class="hidden bg-purple-800 hover:bg-purple-900 text-white font-bold py-3 px-10 rounded-lg text-xl shadow-xl transform transition hover:scale-105">ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
                    <p id="dobon-wait-message" class="hidden text-sm font-bold animate-pulse">æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œå¾…ã¡...</p>
                </div>
            </div>
        </div>

        <div id="joker-suit-modal" class="hidden modal-overlay">
            <div class="modal-content max-w-md">
                <h2 class="text-2xl font-bold mb-4">ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã®ã‚¹ãƒ¼ãƒˆé¸æŠ</h2>
                <p class="mb-6 text-sm text-gray-300">ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã‚’ã©ã®ã‚¹ãƒ¼ãƒˆã¨ã—ã¦æ‰±ã„ã¾ã™ã‹ï¼Ÿ<br>(ç¸›ã‚Šå›é¿ãªã©ã«åˆ©ç”¨ã§ãã¾ã™)</p>
                <div id="joker-suit-buttons" class="flex justify-center gap-4">
                    <button class="suit-button text-gray-800" data-suit="S">â™ </button>
                    <button class="suit-button text-red-500" data-suit="H">â™¥</button>
                    <button class="suit-button text-red-500" data-suit="D">â™¦</button>
                    <button class="suit-button text-gray-800" data-suit="C">â™£</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, runTransaction, deleteField } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAduXdqwj7aeFAN9sHajCEsX0BDcUWHSv4",
            authDomain: "dai-fugo.firebaseapp.com",
            projectId: "dai-fugo",
            storageBucket: "dai-fugo.firebasestorage.app",
            messagingSenderId: "83747675254",
            appId: "1:83747675254:web:652d8bed0fe1ce045f5357"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const appId = firebaseConfig.projectId;
        let currentUser = null;
        let currentRoomId = null;
        let currentHostId = null;
        let unsubscribeRoom = null;
        let selectedCards = [];
        let cardsForSelection = [];
        let localRoomData = {};
        let localGameState = {};
        let acknowledgedEventTimestamp = null;

        const SUITS = ['S', 'H', 'D', 'C'];
        const NUMBERS = [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 1, 2];
        const JOKER = { suit: 'JOKER', number: 99, id: 'JOKER' };

        // Elements
        const homeScreen = document.getElementById('home-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        
        const gameOverModal = document.getElementById('game-over-modal');
        const selectionModal = document.getElementById('selection-modal');
        const eightGiriModal = document.getElementById('8giri-modal');
        const fiveSkipModal = document.getElementById('5skip-modal');
        const receivedCardsModal = document.getElementById('received-cards-modal');
        const dobonSuccessModal = document.getElementById('dobon-success-modal');
        const jokerSuitModal = document.getElementById('joker-suit-modal');
        const spade3Modal = document.getElementById('spade3-modal');
        const agariModal = document.getElementById('agari-modal');
        
        const leaveGameBtn = document.getElementById('leave-game-btn');

        // --- Auth & Initialization ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const savedRoomId = sessionStorage.getItem('daifugoRoomId');
                if (savedRoomId && !currentRoomId) {
                    await rejoinRoom(savedRoomId);
                }
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Auth Error:", error);
                    showMessage("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
                }
            }
        });

        // --- UI Helper Functions ---
        function showScreen(screen) {
            homeScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        function showMessage(message, duration = 3000) {
            const modal = document.getElementById('message-modal');
            const content = document.getElementById('message-content');
            content.textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('hidden'), duration);
        }

        window.copyRoomId = function() {
            const roomId = document.getElementById('room-id-display').textContent;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(roomId).then(() => showMessage('ãƒ«ãƒ¼ãƒ IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))
                .catch(() => fallbackCopyTextToClipboard(roomId));
            } else {
                fallbackCopyTextToClipboard(roomId);
            }
        };

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('ãƒ«ãƒ¼ãƒ IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            } catch (err) {
                showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            document.body.removeChild(textArea);
        }

        // --- Room Management ---
        async function createRoom() {
            if (!currentUser) return showMessage("èªè¨¼æº–å‚™ä¸­...");
            const playerName = document.getElementById('player-name').value.trim() || `ã‚²ã‚¹ãƒˆ${Math.floor(Math.random()*100)}`;
            const roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
            
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, roomId);
            const newRoom = {
                roomId: roomId,
                hostId: currentUser.uid,
                players: [{ id: currentUser.uid, name: playerName, view: 'lobby' }],
                lastGameResult: null
            };

            try {
                await setDoc(roomRef, newRoom);
                currentRoomId = roomId;
                sessionStorage.setItem('daifugoRoomId', roomId);
                listenToRoomChanges(roomId);
            } catch (error) {
                console.error("Create Room Error:", error);
                showMessage("ä½œæˆå¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
        }

        async function joinRoom() {
            if (!currentUser) return showMessage("èªè¨¼æº–å‚™ä¸­...");
            const roomId = document.getElementById('room-id-input').value.trim().toUpperCase();
            if (!roomId) return showMessage("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            const playerName = document.getElementById('player-name').value.trim() || `ã‚²ã‚¹ãƒˆ${Math.floor(Math.random()*100)}`;
            
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, roomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) throw new Error("ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    const roomData = roomDoc.data();
                    if (roomData.gameState) throw new Error("ã‚²ãƒ¼ãƒ é€²è¡Œä¸­ã§ã™ã€‚");

                    if (!roomData.players.find(p => p.id === currentUser.uid)) {
                        if (roomData.players.length >= 6) throw new Error("æº€å“¡ã§ã™ã€‚");
                        const newPlayer = { id: currentUser.uid, name: playerName, view: 'lobby' };
                        transaction.update(roomRef, { players: [...roomData.players, newPlayer] });
                    }
                });
                currentRoomId = roomId;
                sessionStorage.setItem('daifugoRoomId', roomId);
                listenToRoomChanges(roomId);
            } catch (error) {
                showMessage(error.message);
            }
        }

        async function rejoinRoom(roomId) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, roomId);
            try {
                const roomDoc = await getDoc(roomRef);
                if (!roomDoc.exists() || !roomDoc.data().players.some(p => p.id === currentUser.uid)) {
                    cleanupClientState();
                    return;
                }
                currentRoomId = roomId;
                listenToRoomChanges(roomId);
            } catch (error) {
                cleanupClientState();
            }
        }

        function cleanupClientState() {
            sessionStorage.removeItem('daifugoRoomId');
            if (unsubscribeRoom) unsubscribeRoom();
            unsubscribeRoom = null;
            currentRoomId = null;
            localRoomData = {};
            localGameState = {};
            showScreen(homeScreen);
            leaveGameBtn.classList.add('hidden');
        }

        // ã€ä¿®æ­£ã€‘ é€€å‡ºé–¢æ•°ã‚’è¿½åŠ 
        function confirmAndLeave() {
            if (confirm("æœ¬å½“ã«ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ")) {
                handleLeaveGame();
            }
        }

        async function handleLeaveGame() {
            if (!currentRoomId || !currentUser) return cleanupClientState();
            const roomId = currentRoomId;
            const userId = currentUser.uid;
            
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, roomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) return;
                    let roomData = roomDoc.data();
                    if (!roomData.players.find(p => p.id === userId)) return;

                    let remaining = roomData.players.filter(p => p.id !== userId);
                    if (remaining.length === 0) {
                        transaction.delete(roomRef);
                    } else {
                        let updates = { players: remaining };
                        if (roomData.hostId === userId) updates.hostId = remaining[0].id;
                        transaction.update(roomRef, updates);
                    }
                });
            } catch (e) { console.error(e); }
            finally { cleanupClientState(); }
        }

        // --- Game Logic Core ---
        function createDeck() {
            const deck = [];
            SUITS.forEach(suit => {
                NUMBERS.forEach(number => deck.push({ suit, number, id: `${suit}${number}` }));
            });
            deck.push({ ...JOKER, id: 'JOKER1' });
            deck.push({ ...JOKER, id: 'JOKER2' });
            return deck;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function startGame() {
            if (!currentRoomId) return;
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                 await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) return;
                    const roomData = roomDoc.data();
                    if (roomData.players.length < 2) throw new Error("2äººä»¥ä¸Šå¿…è¦ã§ã™ã€‚");
                    
                    const deck = shuffle(createDeck());
                    const hands = {};
                    roomData.players.forEach(p => hands[p.id] = []);
                    let idx = 0;
                    deck.forEach(c => {
                        hands[roomData.players[idx].id].push(c);
                        idx = (idx + 1) % roomData.players.length;
                    });
                    
                    // æ‰‹æœ­ã‚½ãƒ¼ãƒˆ
                    Object.keys(hands).forEach(pid => {
                        hands[pid].sort((a, b) => getCardStrength(a) - getCardStrength(b));
                    });

                    // é †ç•ªæ±ºã‚ï¼šå‰å›ã®é †ä½(rank)é †ã€ãªã‘ã‚Œã°ç™»éŒ²é †
                    const sortedPlayers = [...roomData.players].sort((a, b) => (a.rank || 99) - (b.rank || 99));
                    const playOrder = sortedPlayers.map(p => p.id);

                    // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ±ºå®š (ãƒ«ãƒ¼ãƒ« ç¬¬2ç« )
                    let currentPlayerId;
                    const loser = roomData.players.find(p => p.rank === roomData.players.length);
                    if (loser) {
                        currentPlayerId = loser.id; // å¤§è²§æ°‘ã‚¹ã‚¿ãƒ¼ãƒˆ
                    } else {
                        // åˆå›: ãƒ€ã‚¤ãƒ¤ã®3
                        const d3Owner = Object.keys(hands).find(id => hands[id].some(c => c.suit === 'D' && c.number === 3));
                        currentPlayerId = d3Owner || playOrder[0];
                    }
                    
                    const playersInGame = roomData.players.map(p => ({ ...p, cardCount: hands[p.id].length, rank: null }));
                    
                    const newGameState = {
                        status: 'playing',
                        hands: hands,
                        players: playersInGame,
                        playOrder: playOrder,
                        currentPlayerId: currentPlayerId,
                        field: { cards: [], lastPlayerId: null, suitLock: null },
                        passCount: 0,
                        isRevolution: false,
                        isElevenBack: false,
                        rankings: [],
                        log: [],
                        lastActionTimestamp: new Date().toISOString()
                    };
                    
                    transaction.update(roomRef, { 
                        gameState: newGameState, 
                        players: roomData.players.map(p => ({ ...p, view: 'game' })), 
                        lastGameResult: deleteField() 
                    });
                 });
            } catch(e) { showMessage(e.message); }
        }

        // --- Play Action ---
        async function playCards() {
            if (selectedCards.length === 0) return;
            
            // ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã®æ•°å€¤ã‚’æ±ºã‚ã‚‹ãŸã‚ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
            const hasJoker = selectedCards.some(c => c.suit === 'JOKER');
            const numberCards = selectedCards.filter(c => c.suit !== 'JOKER');
            
            if (hasJoker && numberCards.length > 0) {
                // è¤‡æ•°æšå‡ºã—ã®ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã¯ã‚¹ãƒ¼ãƒˆã‚’é¸æŠã•ã›ã‚‹ï¼ˆç¸›ã‚Šåˆ¤å®šç”¨ï¼‰
                promptJokerSuit();
            } else {
                executePlay(selectedCards);
            }
        }

        async function executePlay(cardsToPlay) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) throw new Error("ã‚¨ãƒ©ãƒ¼");
                    
                    let roomData = roomDoc.data();
                    let gs = roomData.gameState;
                    
                    if (currentUser.uid !== gs.currentPlayerId) throw new Error("æ‰‹ç•ªã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                    
                    const validation = isValidPlay(cardsToPlay, gs.field, gs.isRevolution, gs.isElevenBack);
                    if (!validation.valid) throw new Error(validation.message);

                    // åå‰‡ã‚ãŒã‚Šãƒã‚§ãƒƒã‚¯ (ãƒ«ãƒ¼ãƒ« ç¬¬9ç« )
                    const myHand = gs.hands[currentUser.uid];
                    if (myHand.length === cardsToPlay.length) {
                        const checkCard = cardsToPlay.find(c => c.suit !== 'JOKER') || cardsToPlay[0];
                        const strNum = gs.isRevolution ? 3 : 2;
                        if (checkCard.suit === 'JOKER' || checkCard.number === strNum) {
                            throw new Error("åå‰‡ã‚ãŒã‚Šã§ã™ï¼(ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼/æœ€å¼·æ•°å­—)");
                        }
                    }

                    // æ‰‹æœ­æ›´æ–°
                    const newHand = myHand.filter(c => !cardsToPlay.find(sc => sc.id === c.id));
                    gs.hands[currentUser.uid] = newHand;
                    
                    // ã‚«ãƒ¼ãƒ‰æƒ…å ±è§£æ
                    const mainCard = cardsToPlay.find(c => c.suit !== 'JOKER') || cardsToPlay[0];
                    const playedNum = mainCard.number;
                    const count = cardsToPlay.length;

                    // ã‚¹ãƒš3è¿”ã—åˆ¤å®š (ãƒ«ãƒ¼ãƒ« ç¬¬3ç« )
                    const isSpade3 = (gs.field.cards.length === 1 && gs.field.cards[0].suit === 'JOKER' && 
                                      cardsToPlay.length === 1 && cardsToPlay[0].suit === 'S' && cardsToPlay[0].number === 3);

                    // ã‚ãŒã‚Šåˆ¤å®š
                    let finished = false;
                    if (newHand.length === 0) finished = true;
                    
                    // 7æ¸¡ã—/10æ¨ã¦ã§ã‚ãŒã‚‹å ´åˆã€å³ã‚ãŒã‚Šæ‰±ã„ã ãŒã‚«ãƒ¼ãƒ‰ç§»å‹•å‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—
                    if ((playedNum === 7 || playedNum === 10) && newHand.length > 0 && newHand.length <= count) {
                        finished = true;
                        gs.hands[currentUser.uid] = [];
                    }

                    if (finished) {
                        gs.status = 'awaiting_agari_acknowledgement';
                        gs.pendingAction = { type: 'agari', playerId: currentUser.uid };
                        gs.rankings.push(currentUser.uid);
                    } else {
                        // ç‰¹æ®Šå‡¦ç†åˆ†å²
                        if (isSpade3) {
                            gs.status = 'awaiting_spade3_confirmation';
                            gs.pendingAction = { type: 'spade3', playerId: currentUser.uid };
                        } else if (playedNum === 8) {
                            gs.status = 'awaiting_8giri_confirmation';
                            gs.pendingAction = { type: '8-giri', playerId: currentUser.uid };
                        } else if (playedNum === 5) {
                            gs.status = 'awaiting_5skip_confirmation';
                            gs.pendingAction = { type: '5-skip', playerId: currentUser.uid, count: count };
                        } else if (playedNum === 7 || playedNum === 10) {
                            gs.status = 'awaiting_selection';
                            gs.pendingAction = { type: playedNum === 7 ? '7-pass' : '10-discard', playerId: currentUser.uid, count: count };
                        } else {
                            // é©å‘½ãƒ»ã‚¤ãƒ¬ãƒ–ãƒ³ãƒãƒƒã‚¯åˆ¤å®š (ãƒ«ãƒ¼ãƒ« ç¬¬7ç« )
                            const effect = handleSpecialCards(cardsToPlay, gs);
                            gs = effect.newGameState;
                            if (!effect.skipTurn) {
                                gs.currentPlayerId = getNextPlayerId(gs);
                            }
                        }
                        gs.passCount = 0;
                    }

                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°
                    gs.field = { cards: cardsToPlay, lastPlayerId: currentUser.uid, suitLock: validation.newSuitLock };
                    gs.players = gs.players.map(p => ({...p, cardCount: gs.hands[p.id]?.length || 0 }));
                    gs.lastActionTimestamp = new Date().toISOString();

                    // ã‚²ãƒ¼ãƒ çµ‚äº†åˆ¤å®š
                    const active = gs.players.filter(p => !gs.rankings.includes(p.id));
                    if (active.length <= 1 && !finished) { // ã‚ãŒã‚Šå¾…æ©Ÿä¸­ã¯é™¤å¤–
                         const last = active[0];
                         if(last) gs.rankings.push(last.id);
                         finishGame(transaction, roomRef, roomData, gs.rankings);
                    } else {
                         transaction.update(roomRef, { gameState: gs });
                    }
                });
                selectedCards = [];
            } catch (e) {
                console.error(e);
                showMessage(e.message);
            }
        }

        // --- Pass Logic ---
        async function passTurn() {
            if (currentUser.uid !== localGameState.currentPlayerId) return;
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) return;
                    let gs = roomDoc.data().gameState;
                    
                    gs.passCount += 1;
                    const activeCount = gs.players.filter(p => p.cardCount > 0 && !gs.rankings.includes(p.id)).length;

                    // å…¨å“¡ãƒ‘ã‚¹ã§å ´ãŒæµã‚Œã‚‹
                    if (gs.passCount >= activeCount - 1 && gs.field.lastPlayerId) {
                        gs.currentPlayerId = gs.field.lastPlayerId; // è¦ªã«ãªã‚‹
                        clearFieldAndReset(gs);
                    } else {
                        gs.currentPlayerId = getNextPlayerId(gs);
                    }
                    gs.lastActionTimestamp = new Date().toISOString();
                    transaction.update(roomRef, { gameState: gs });
                });
            } catch (e) { showMessage(e.message); }
        }

        // --- Dobon Logic ---
        async function declareDobon() {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    let gs = roomDoc.data().gameState;
                    const myHand = gs.hands[currentUser.uid];
                    const field = gs.field.cards;

                    if (myHand.length < 2) throw new Error("æ‰‹æœ­2æšä»¥ä¸Šå¿…è¦ã§ã™ã€‚");
                    if (!field || field.length === 0) throw new Error("å ´ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                    if (gs.field.lastPlayerId === currentUser.uid) throw new Error("è‡ªåˆ†ã«ã¯ãƒ‰ãƒœãƒ³ã§ãã¾ã›ã‚“ã€‚");

                    const handSum = myHand.reduce((s, c) => s + (c.suit==='JOKER'?0:c.number), 0);
                    const fieldSum = field.reduce((s, c) => s + (c.suit==='JOKER'?0:c.number), 0);

                    if (handSum !== fieldSum) throw new Error(`ä¸ä¸€è‡´ï¼ æ‰‹æœ­:${handSum} å ´:${fieldSum}`);

                    // ãƒ‰ãƒœãƒ³æˆåŠŸ
                    gs.status = 'awaiting_dobon_acknowledgement';
                    gs.rankings.push(currentUser.uid);
                    gs.hands[currentUser.uid] = []; // æ‰‹æœ­ã‚’ç©ºã«
                    
                    gs.dobonInfo = {
                        playerName: gs.players.find(p => p.id === currentUser.uid).name,
                        playerHand: myHand,
                        fieldCards: field,
                        sum: handSum,
                        nextPlayerId: getNextPlayerId(gs)
                    };
                    transaction.update(roomRef, { gameState: gs });
                });
            } catch (e) { showMessage(e.message); }
        }

        // --- Special Card Handlers ---
        function handleSpecialCards(played, gs) {
            const nonJokers = played.filter(c => c.suit !== 'JOKER');
            const nums = [...new Set(nonJokers.map(c => c.number))];
            const mainNum = nums[0] || played[0].number;
            const count = played.length;

            // é©å‘½ (4æšå‡ºã— / 3ã‚’3æš)
            const isRev4 = (count === 4);
            const isRev3 = (count === 3 && mainNum === 3 && nonJokers.length > 0);
            
            if (isRev4 || isRev3) {
                gs.isRevolution = !gs.isRevolution;
            }

            // ã‚¤ãƒ¬ãƒ–ãƒ³ãƒãƒƒã‚¯ (11å¥‡æ•°æš)
            if (mainNum === 11 && count % 2 !== 0) {
                gs.isElevenBack = !gs.isElevenBack;
            }

            return { newGameState: gs, skipTurn: false };
        }

        // --- Helper Logic ---
        function clearFieldAndReset(gameState) {
            gameState.field = { cards: [], lastPlayerId: null, suitLock: null };
            gameState.passCount = 0;
            if (gameState.isElevenBack) gameState.isElevenBack = false;
        }

        function getCardStrength(card, isRevolution = false, isElevenBack = false) {
            if (card.suit === 'JOKER') return 999;
            const rev = isRevolution !== isElevenBack; // XOR logic
            let s = card.number;
            if (s === 1) s = 14;
            if (s === 2) s = 15;
            if (rev) {
                if (s === 3) return 16; // é©å‘½æ™‚ã¯3ãŒæœ€å¼·
                return 15 - (s - 3);
            }
            return s;
        }

        function isValidPlay(played, field, isRev, is11Back) {
            if (!played.length) return { valid: false, message: "é¸æŠã—ã¦ãã ã•ã„" };
            
            const playIsJoker = played.length === 1 && played[0].suit === 'JOKER';
            const playIsSpade3 = played.length === 1 && played[0].suit === 'S' && played[0].number === 3;
            const fieldIsJoker = field.cards.length === 1 && field.cards[0].suit === 'JOKER';

            const nums = played.map(c => c.suit==='JOKER' ? null : c.number).filter(n => n !== null);
            if ([...new Set(nums)].length > 1) return { valid: false, message: "åŒã˜æ•°å­—ã®ã¿å‡ºã›ã¾ã™" };

            // ã‚¹ãƒš3 vs Joker
            if (fieldIsJoker && playIsSpade3) return { valid: true, newSuitLock: null };

            if (field.cards.length > 0) {
                if (played.length !== field.cards.length) return { valid: false, message: "æšæ•°ãŒé•ã„ã¾ã™" };

                const pStr = getCardStrength(played.find(c => c.suit!=='JOKER')||played[0], isRev, is11Back);
                const fStr = getCardStrength(field.cards.find(c => c.suit!=='JOKER')||field.cards[0], isRev, is11Back);

                if (pStr <= fStr) return { valid: false, message: "å¼±ã„ã‚«ãƒ¼ãƒ‰ã¯å‡ºã›ã¾ã›ã‚“" };

                // ç¸›ã‚Šåˆ¤å®š
                if (field.suitLock) {
                    const pSuits = getCombinedSuits(played);
                    if (pSuits !== field.suitLock) return { valid: false, message: `ç¸›ã‚Šï¼[${field.suitLock}]ã®ã¿å¯` };
                }
            }

            let newLock = null;
            if (field.cards.length > 0) {
                const fSuits = getCombinedSuits(field.cards);
                const pSuits = getCombinedSuits(played);
                if (fSuits === pSuits) newLock = pSuits;
            }

            return { valid: true, newSuitLock: newLock };
        }

        function getCombinedSuits(cards) {
            const suits = cards.map(c => c.designatedSuit || c.suit).filter(s => s !== 'JOKER');
            return [...new Set(suits)].sort().join('');
        }

        function getNextPlayerId(gs) {
            let idx = gs.playOrder.indexOf(gs.currentPlayerId);
            let nextId;
            let safety = 0;
            do {
                idx = (idx + 1) % gs.playOrder.length;
                nextId = gs.playOrder[idx];
                safety++;
            } while (gs.rankings.includes(nextId) && safety < 10);
            return nextId;
        }

        function finishGame(transaction, roomRef, roomData, rankings) {
            const finishedPlayers = roomData.players.map(p => ({...p, view: 'results'}));
            transaction.update(roomRef, {
                players: finishedPlayers,
                lastGameResult: { rankings: rankings },
                gameState: deleteField()
            });
        }

        // ã€ä¿®æ­£ã€‘ æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£ãƒ»å¤‰æ•°åç«¶åˆè§£æ¶ˆï¼‰
        async function handleNextGameClick() {
            gameOverModal.classList.add('hidden');
            showScreen(lobbyScreen);
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            
            try {
                await runTransaction(db, async (t) => {
                    // 'doc'ã¨ã„ã†å¤‰æ•°åã‚’ 'roomDoc' ã«å¤‰æ›´ã—ã¦ç«¶åˆå›é¿
                    const roomDoc = await t.get(roomRef);
                    if(!roomDoc.exists()) return;
                    const d = roomDoc.data();
                    
                    // è‡ªåˆ†ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ 'lobby' ã«æ›´æ–°
                    const pl = d.players.map(p => {
                         const r = d.lastGameResult?.rankings?.indexOf(p.id);
                         return (p.id === currentUser.uid) 
                            ? { ...p, view: 'lobby', rank: r!==-1 ? r+1 : d.players.length } 
                            : p;
                    });
                    
                    // å…¨å“¡ãŒãƒ­ãƒ“ãƒ¼ã«æˆ»ã£ã¦ã„ã‚Œã°ã€èª°ã§ã‚ã£ã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
                    if(pl.every(p => p.view === 'lobby')) {
                        t.update(roomRef, { players: pl, gameState: deleteField(), lastGameResult: deleteField() });
                    } else {
                        t.update(roomRef, { players: pl });
                    }
                });
            } catch(e) { console.error(e); }
        }

        // 8åˆ‡ã‚Šã€5ã‚¹ã‚­ãƒƒãƒ—ã€ã‚¹ãƒš3è¿”ã—ã€ã‚ãŒã‚Šç¢ºèªå¾Œã®é€²è¡Œå‡¦ç†
        async function confirmAction(modalId, statusCheck) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (t) => {
                    const roomDoc = await t.get(roomRef);
                    let gs = roomDoc.data().gameState;
                    if (gs.status !== statusCheck || gs.pendingAction?.playerId !== currentUser.uid) return;

                    if (statusCheck === 'awaiting_5skip_confirmation') {
                         const skips = (2 * gs.pendingAction.count) - 1;
                         const active = gs.players.filter(p => !gs.rankings.includes(p.id)).length;
                         if (skips >= active - 1) {
                             clearFieldAndReset(gs);
                             gs.currentPlayerId = currentUser.uid;
                         } else {
                             let target = currentUser.uid;
                             for(let i=0; i<=skips; i++) target = getNextPlayerId({...gs, currentPlayerId: target});
                             gs.currentPlayerId = target;
                         }
                    } else {
                        clearFieldAndReset(gs);
                        if (statusCheck === 'awaiting_agari_acknowledgement') {
                             gs.currentPlayerId = getNextPlayerId(gs);
                        } else {
                             gs.currentPlayerId = currentUser.uid;
                        }
                    }
                    
                    gs.status = 'playing';
                    delete gs.pendingAction;

                    const active = gs.players.filter(p => !gs.rankings.includes(p.id));
                    if (active.length <= 1) {
                        if(active[0]) gs.rankings.push(active[0].id);
                        finishGame(t, roomRef, roomDoc.data(), gs.rankings);
                    } else {
                        t.update(roomRef, { gameState: gs });
                    }
                });
                document.getElementById(modalId).classList.add('hidden');
            } catch(e){ console.error(e); }
        }
        
        // 7æ¸¡ã— / 10æ¨ã¦ é¸æŠå‡¦ç†
        async function confirmSelection() {
            const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
            try {
                await runTransaction(db, async (t) => {
                    const roomDoc = await t.get(roomRef);
                    let gs = roomDoc.data().gameState;
                    const action = gs.pendingAction;
                    
                    if (cardsForSelection.length !== action.count) throw new Error("æšæ•°ãŒä¸æ­£ã§ã™");

                    // æ‰‹æœ­ã‹ã‚‰å‰Šé™¤
                    gs.hands[currentUser.uid] = gs.hands[currentUser.uid].filter(c => !cardsForSelection.some(sc => sc.id === c.id));
                    
                    if (action.type === '7-pass') {
                        const nextId = getNextPlayerId(gs);
                        gs.hands[nextId].push(...cardsForSelection);
                        gs.hands[nextId].sort((a,b) => getCardStrength(a) - getCardStrength(b));
                        gs.lastEvent = { type: '7-pass', recipientId: nextId, senderName: gs.players.find(p=>p.id===currentUser.uid).name, cards: cardsForSelection, timestamp: Date.now() };
                    }

                    gs.status = 'playing';
                    gs.currentPlayerId = getNextPlayerId(gs);
                    delete gs.pendingAction;
                    
                    // ã‚ãŒã‚Šãƒã‚§ãƒƒã‚¯
                    if (gs.hands[currentUser.uid].length === 0 && !gs.rankings.includes(currentUser.uid)) {
                        gs.rankings.push(currentUser.uid);
                        const active = gs.players.filter(p => !gs.rankings.includes(p.id));
                        if (active.length <= 1) {
                            if(active[0]) gs.rankings.push(active[0].id);
                            finishGame(t, roomRef, roomDoc.data(), gs.rankings);
                            return;
                        }
                    }
                    
                    t.update(roomRef, { gameState: gs });
                });
                selectionModal.classList.add('hidden');
                cardsForSelection = [];
            } catch(e) { showMessage(e.message); }
        }
        
        // ãƒ‰ãƒœãƒ³ã‹ã‚‰ã®å¾©å¸°
        async function resumeAfterDobon() {
             const roomRef = doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, currentRoomId);
             await runTransaction(db, async (t) => {
                 const d = (await t.get(roomRef)).data();
                 let gs = d.gameState;
                 if (gs.status !== 'awaiting_dobon_acknowledgement') return;
                 
                 gs.currentPlayerId = gs.dobonInfo.nextPlayerId;
                 clearFieldAndReset(gs);
                 delete gs.dobonInfo;
                 gs.status = 'playing';
                 
                 const active = gs.players.filter(p => !gs.rankings.includes(p.id));
                 if (active.length <= 1) {
                     if(active[0]) gs.rankings.push(active[0].id);
                     finishGame(t, roomRef, d, gs.rankings);
                 } else {
                     t.update(roomRef, { gameState: gs });
                 }
             });
             dobonSuccessModal.classList.add('hidden');
        }

        // --- UI Updates (Listeners) ---
        function listenToRoomChanges(roomId) {
            if (unsubscribeRoom) unsubscribeRoom();
            unsubscribeRoom = onSnapshot(doc(db, `artifacts/${appId}/public/data/daifugo-rooms`, roomId), (snapshot) => {
                if (!snapshot.exists()) { cleanupClientState(); return; }
                
                localRoomData = snapshot.data();
                localGameState = localRoomData.gameState || {};
                currentHostId = localRoomData.hostId;
                leaveGameBtn.classList.remove('hidden');

                const me = localRoomData.players.find(p => p.id === currentUser.uid);
                if (!me) { cleanupClientState(); return; }
                
                document.getElementById('player-count').textContent = `(${localRoomData.players.length}äºº)`;

                if (me.view === 'game' && localGameState.status) {
                    updateGameUI(localGameState, localRoomData.players);
                } else if (me.view === 'results') {
                    showGameOverUI(localRoomData);
                } else {
                    showScreen(lobbyScreen);
                    updateLobbyUI(localRoomData);
                }
                
                if (localGameState.lastEvent && localGameState.lastEvent.recipientId === currentUser.uid && 
                    localGameState.lastEvent.timestamp !== acknowledgedEventTimestamp) {
                    acknowledgedEventTimestamp = localGameState.lastEvent.timestamp;
                    showReceivedCards(localGameState.lastEvent);
                }
            });
        }

        function updateLobbyUI(data) {
            document.getElementById('room-id-display').textContent = data.roomId;
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            data.players.forEach(p => {
                const li = document.createElement('li');
                li.className = 'bg-white/10 p-3 rounded flex justify-between items-center';
                li.innerHTML = `<span>${p.name}</span>${p.id === data.hostId ? '<span class="text-xs bg-yellow-500 text-black px-2 py-1 rounded font-bold">HOST</span>' : ''}`;
                list.appendChild(li);
            });
            const btn = document.getElementById('start-game-btn');
            if (currentUser.uid === data.hostId) {
                btn.classList.remove('hidden');
                btn.disabled = data.players.length < 2;
            } else {
                btn.classList.add('hidden');
            }
        }

        function updateGameUI(gs, players) {
            showScreen(gameScreen);
            
            const handDiv = document.getElementById('my-hand');
            handDiv.innerHTML = '';
            const myHand = gs.hands[currentUser.uid] || [];
            const finished = gs.rankings.includes(currentUser.uid);
            
            if (finished) {
                const rank = gs.rankings.indexOf(currentUser.uid) + 1;
                handDiv.innerHTML = `<div class="text-3xl font-bold text-yellow-400 animate-bounce py-8">ã‚ãªãŸã¯ ${rank}ä½ ã§ã™</div>`;
            } else {
                myHand.forEach(c => {
                    const el = createCardEl(c);
                    if (selectedCards.some(s => s.id === c.id)) el.classList.add('selected');
                    el.onclick = () => toggleSelect(c, el);
                    handDiv.appendChild(el);
                });
            }

            const fieldDiv = document.getElementById('field');
            fieldDiv.innerHTML = '';
            (gs.field.cards||[]).forEach(c => fieldDiv.appendChild(createCardEl(c)));
            
            const infoDiv = document.getElementById('game-info');
            infoDiv.innerHTML = '';
            if (gs.isRevolution) infoDiv.innerHTML += '<span class="text-red-500 bg-white/20 px-2 rounded">é©å‘½ä¸­</span>';
            if (gs.isElevenBack) infoDiv.innerHTML += '<span class="text-blue-400 bg-white/20 px-2 rounded">ã‚¤ãƒ¬ãƒ–ãƒ³ãƒãƒƒã‚¯</span>';
            if (gs.field.suitLock) infoDiv.innerHTML += `<span class="text-green-400 bg-white/20 px-2 rounded">ç¸›ã‚Š: ${gs.field.suitLock}</span>`;

            const otherDiv = document.getElementById('other-players-container');
            otherDiv.innerHTML = '';
            const myIdx = players.findIndex(p => p.id === currentUser.uid);
            const ordered = [...players.slice(myIdx + 1), ...players.slice(0, myIdx)];
            ordered.forEach(p => {
                const div = document.createElement('div');
                div.className = `player-info p-2 rounded text-center bg-black/40 ${p.id === gs.currentPlayerId ? 'current-turn' : ''}`;
                const rankIdx = gs.rankings.indexOf(p.id);
                div.innerHTML = `
                    <div class="font-bold truncate">${p.name}</div>
                    <div class="text-2xl">${rankIdx !== -1 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£'][rankIdx] : 'ğŸƒ' + p.cardCount}</div>
                `;
                otherDiv.appendChild(div);
            });

            const isTurn = gs.currentPlayerId === currentUser.uid && !finished;
            const locked = gs.status.startsWith('awaiting');
            document.getElementById('play-card-btn').disabled = !isTurn || locked;
            document.getElementById('pass-btn').disabled = !isTurn || locked || (!gs.field.cards.length);
            
            const canDobon = !locked && !finished && myHand.length >= 2 && gs.field.cards.length > 0 && gs.field.lastPlayerId !== currentUser.uid;
            document.getElementById('dobon-btn').disabled = !canDobon;

            if (gs.pendingAction?.playerId === currentUser.uid) {
                if (gs.status === 'awaiting_selection') showSelectionModal(gs.pendingAction, myHand);
                else if (gs.status === 'awaiting_8giri_confirmation') eightGiriModal.classList.remove('hidden');
                else if (gs.status === 'awaiting_5skip_confirmation') fiveSkipModal.classList.remove('hidden');
                else if (gs.status === 'awaiting_spade3_confirmation') spade3Modal.classList.remove('hidden');
                else if (gs.status === 'awaiting_agari_acknowledgement') agariModal.classList.remove('hidden');
            }
            
            if (gs.status === 'awaiting_dobon_acknowledgement') {
                showDobonModal(gs);
            }
        }
        
        function createCardEl(c) {
            const div = document.createElement('div');
            div.className = 'card shadow-md';
            if (c.suit === 'JOKER') {
                div.classList.add('joker');
                div.innerHTML = `<span class="text-xs">JOKER</span><span class="text-3xl">ğŸƒ</span><span class="text-xs rotate-180">JOKER</span>`;
                if (c.designatedSuit) {
                    const s = {S:'â™ ',H:'â™¥',D:'â™¦',C:'â™£'}[c.designatedSuit];
                    div.innerHTML += `<span class="designated-suit ${['H','D'].includes(c.designatedSuit)?'text-red-500':'text-black'}">${s}</span>`;
                }
            } else {
                const color = ['H','D'].includes(c.suit) ? 'red' : 'black';
                const mark = {S:'â™ ',H:'â™¥',D:'â™¦',C:'â™£'}[c.suit];
                const num = {1:'A',11:'J',12:'Q',13:'K'}[c.number] || c.number;
                div.classList.add(color);
                div.innerHTML = `<div class="suit-top text-left pl-1">${mark}</div><div class="number flex-1 flex items-center justify-center">${num}</div><div class="suit-bottom text-right pr-1">${mark}</div>`;
            }
            return div;
        }

        function toggleSelect(c, el) {
            const idx = selectedCards.findIndex(s => s.id === c.id);
            if (idx > -1) {
                selectedCards.splice(idx, 1);
                el.classList.remove('selected');
            } else {
                selectedCards.push(c);
                el.classList.add('selected');
            }
        }

        function promptJokerSuit() {
            jokerSuitModal.classList.remove('hidden');
            const used = selectedCards.filter(c=>c.suit!=='JOKER').map(c=>c.suit);
            document.querySelectorAll('.suit-button').forEach(b => {
                b.disabled = used.includes(b.dataset.suit);
                b.onclick = () => {
                    selectedCards = selectedCards.map(c => c.suit==='JOKER' ? {...c, designatedSuit: b.dataset.suit} : c);
                    jokerSuitModal.classList.add('hidden');
                    executePlay(selectedCards);
                };
            });
        }

        function showSelectionModal(action, hand) {
            selectionModal.classList.remove('hidden');
            document.getElementById('selection-title').textContent = action.type==='7-pass'?'7æ¸¡ã—':'10æ¨ã¦';
            document.getElementById('selection-description').textContent = `${action.count}æšé¸ã‚“ã§ãã ã•ã„`;
            const container = document.getElementById('selection-hand');
            container.innerHTML = '';
            cardsForSelection = [];
            document.getElementById('confirm-selection-btn').disabled = true;
            
            hand.forEach(c => {
                const el = createCardEl(c);
                el.onclick = () => {
                    const idx = cardsForSelection.findIndex(s => s.id === c.id);
                    if(idx > -1) { cardsForSelection.splice(idx,1); el.classList.remove('selected'); }
                    else if(cardsForSelection.length < action.count) { cardsForSelection.push(c); el.classList.add('selected'); }
                    document.getElementById('confirm-selection-btn').disabled = cardsForSelection.length !== action.count;
                };
                container.appendChild(el);
            });
        }

        function showReceivedCards(evt) {
            receivedCardsModal.classList.remove('hidden');
            const c = document.getElementById('received-cards-container');
            c.innerHTML = '';
            evt.cards.forEach(card => c.appendChild(createCardEl(card)));
            document.getElementById('received-cards-title').textContent = `${evt.senderName}ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ãŒå±Šãã¾ã—ãŸ`;
        }

        function showDobonModal(gs) {
            dobonSuccessModal.classList.remove('hidden');
            const info = gs.dobonInfo;
            document.getElementById('dobon-player-info').textContent = `${info.playerName} (åˆè¨ˆ:${info.sum})`;
            const hC = document.getElementById('dobon-hand-container'); hC.innerHTML='';
            info.playerHand.forEach(c => hC.appendChild(createCardEl(c)));
            const fC = document.getElementById('dobon-field-container'); fC.innerHTML='';
            info.fieldCards.forEach(c => fC.appendChild(createCardEl(c)));
            
            const isNext = currentUser.uid === info.nextPlayerId;
            document.getElementById('dobon-continue-btn').classList.toggle('hidden', !isNext);
            document.getElementById('dobon-wait-message').classList.toggle('hidden', isNext);
        }

        function showGameOverUI(roomData) {
            gameOverModal.classList.remove('hidden');
            const list = document.getElementById('rankings-list');
            list.innerHTML = '';
            roomData.lastGameResult.rankings.forEach((pid, i) => {
                const p = roomData.players.find(pl => pl.id === pid);
                if(p) list.innerHTML += `<div class="flex justify-between border-b border-white/10 p-2"><span>${i+1}ä½</span><span class="font-bold">${p.name}</span></div>`;
            });
        }

        // --- Event Listeners ---
        document.getElementById('create-room-btn').addEventListener('click', createRoom);
        document.getElementById('join-room-btn').addEventListener('click', joinRoom);
        document.getElementById('start-game-btn').addEventListener('click', startGame);
        document.getElementById('play-card-btn').addEventListener('click', playCards);
        document.getElementById('pass-btn').addEventListener('click', passTurn);
        document.getElementById('dobon-btn').addEventListener('click', declareDobon);
        
        document.getElementById('next-game-btn').addEventListener('click', handleNextGameClick);
        document.getElementById('leave-room-btn').addEventListener('click', confirmAndLeave);
        leaveGameBtn.addEventListener('click', confirmAndLeave);
        
        document.getElementById('confirm-selection-btn').addEventListener('click', confirmSelection);
        document.getElementById('confirm-8giri-btn').addEventListener('click', () => confirmAction('8giri-modal', 'awaiting_8giri_confirmation'));
        document.getElementById('confirm-5skip-btn').addEventListener('click', () => confirmAction('5skip-modal', 'awaiting_5skip_confirmation'));
        document.getElementById('confirm-spade3-btn').addEventListener('click', () => confirmAction('spade3-modal', 'awaiting_spade3_confirmation'));
        document.getElementById('confirm-agari-btn').addEventListener('click', () => confirmAction('agari-modal', 'awaiting_agari_acknowledgement'));
        document.getElementById('received-cards-ok-btn').addEventListener('click', () => receivedCardsModal.classList.add('hidden'));
        document.getElementById('dobon-continue-btn').addEventListener('click', resumeAfterDobon);

    </script>
</body>
</html>
